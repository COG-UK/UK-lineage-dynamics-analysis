<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-10-16 Fri 14:48 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>COVID UK Introductions</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Alex Zarebski" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href=".css/stylesheet.css" />
<script src="https://cdn.jsdelivr.net/npm/vega@5.13.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@4.14.1"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6.10.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite-api@0.11.0"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">COVID UK Introductions</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8cef24e">Data sources</a></li>
<li><a href="#orgf6dddd7">Cleaning deaths time series</a></li>
<li><a href="#org2189a74">Cleaning population sizes</a></li>
<li><a href="#org86f7641">Cleaning IATA data</a></li>
<li><a href="#org96a45f3">Cleaning Home Office data</a></li>
<li><a href="#org030c1fd">Cleaning non-air travel</a></li>
<li><a href="#orgb8ca6da">Cleaning poverty data I</a></li>
<li><a href="#org8d04bc1">Cleaning poverty data II</a></li>
<li><a href="#org752cde7">Estimating number of UK arrivals</a></li>
<li><a href="#org4a5174a">Estimating the proportion of people capable of seeding a cluster</a>
<ul>
<li><a href="#org2f8a07c">Visualisation (HTML version only)</a></li>
</ul>
</li>
<li><a href="#org79ce5d3">Estimate the introduction index for each of the primary source countries</a>
<ul>
<li><a href="#org87aa0d6">Visualisation (HTML version only)</a></li>
</ul>
</li>
<li><a href="#orgc880224">Estimating the lag distribution I (only simulated data)</a>
<ul>
<li><a href="#orged98298">Simulation study</a></li>
</ul>
</li>
<li><a href="#org880a416">Estimating the lag distribution II (only simulated data)</a>
<ul>
<li><a href="#org14dfe0e">Likelihood ratio statistic</a></li>
</ul>
</li>
<li><a href="#orgb04aeae">Estimating the lag distribution III (thresholded MCC tree)</a></li>
<li><a href="#orgbed7b75">Estimating the lag distribution IV (simulation re-estimation)</a></li>
<li><a href="#orgfcde86c">Estimating the lag distribution V (variable threshold MCC tree)</a></li>
<li><a href="#org2c9abe7">Estimating the lag distribution VI (posterior tree uncertainty)</a></li>
<li><a href="#org7088cb1">Extreme poverty adjustment</a>
<ul>
<li><a href="#orgf913412">Estimating the proportion of potential seeders</a></li>
<li><a href="#org425c0c0">Estimating the EII</a></li>
</ul>
</li>
<li><a href="#org11c2dfd">Sensitivity to asymptomatic ratio</a></li>
<li><a href="#org208346e">Using this document and running the analysis</a>
<ul>
<li><a href="#org96858ca">Extracting source code and exporting HTML</a></li>
<li><a href="#org5358a41">Download the data</a></li>
<li><a href="#org5e99828">Run the cleaning scripts</a></li>
<li><a href="#org3d40fb9">Run the estimation scripts</a></li>
<li><a href="#orgaa786ff">Running the simulations</a></li>
<li><a href="#org1bb917b">Running the lag inference</a></li>
<li><a href="#orga48482e">Serving the HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org8cef24e" class="outline-2">
<h2 id="org8cef24e">Data sources</h2>
<div class="outline-text-2" id="text-org8cef24e">
<ul class="org-ul">
<li><code>jhu-data.csv</code></li>
<li><code>un-population.csv</code></li>
<li><code>home-office.csv</code></li>
<li><code>extra-uk-arrivals.csv</code></li>
<li><code>clusters_summary_del.csv</code></li>
<li><code>IATA_CountryLevel_Dec_May.csv</code></li>
</ul>

<p>
Due to ethical and legal restrictions we cannot upload either
<code>clusters_summary_del.csv</code> nor <code>IATA_CountryLevel_Dec_May.csv</code>. To download the
JHU and UN data we have the following script, <code>download-data.sh</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">wget <span style="color: #2d9574;">"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"</span>
mv time_series_covid19_deaths_global.csv raw-data/jhu-deaths.csv

wget <span style="color: #2d9574;">"https://population.un.org/wpp/Download/Files/1_Indicators%20(Standard)/CSV_FILES/WPP2019_TotalPopulationBySex.csv"</span>
mv WPP2019_TotalPopulationBySex.csv raw-data/un-population.csv
</pre>
</div>

<p>
We retrieved data of percentage of country populations living in poverty from
the World Bank, as curated by the team at Our World in data and extracted
estimates of percentages of populations living in poverty from Elvidge <i>et al</i>
(2009) to supplement the World Bank measurements.
</p>
</div>
</div>

<div id="outline-container-orgf6dddd7" class="outline-2">
<h2 id="orgf6dddd7">Cleaning deaths time series</h2>
<div class="outline-text-2" id="text-orgf6dddd7">
<p>
The spatial resolution in the JHU data set varies between countries, in some
instances we need to sum over the different states, such as Australia, and in
some instances we only select the region with the most cases, such as with
France where various provinces are not counted into the primary French death
toll. 
</p>

<p>
The path to the data has the <code>2020-08-19</code> directory in it because this is a time
stamped version of the data that was downloaded on that date.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>magrittr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>purrr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>reshape2<span style="color: #3a81c3;">)</span>

x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/jhu-deaths.csv"</span>,
              header = <span style="color: #4e3163;">TRUE</span>,
              stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    select<span style="color: #3a81c3;">(</span>Province.State,
           Country.Region,
           starts_with<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"X"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Country.Region != <span style="color: #2d9574;">"Diamond Princess"</span>,
           Country.Region != <span style="color: #2d9574;">"MS Zaandam"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    melt<span style="color: #3a81c3;">(</span>id.vars = c<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"Province.State"</span>,<span style="color: #2d9574;">"Country.Region"</span><span style="color: #6c3163;">)</span>,
         value.name = <span style="color: #2d9574;">"cumulative_deaths"</span>,
         variable.name = <span style="color: #2d9574;">"date_string"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date_string, format = <span style="color: #2d9574;">"X%m.%d.%y"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

countries_needing_cleaning <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Province.State != <span style="color: #2d9574;">""</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    use_series<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"Country.Region"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    unique

subset_aus <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Country.Region == <span style="color: #2d9574;">"Australia"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>Country.Region, date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>cumulative_deaths = sum<span style="color: #6c3163;">(</span>cumulative_deaths<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

subset_can <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Country.Region == <span style="color: #2d9574;">"Canada"</span>,
           Province.State != <span style="color: #2d9574;">"Grand Princess"</span>,
           Province.State != <span style="color: #2d9574;">"Diamond Princess"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>Country.Region, date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>cumulative_deaths = sum<span style="color: #6c3163;">(</span>cumulative_deaths<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

subset_chn <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Country.Region == <span style="color: #2d9574;">"China"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>Country.Region, date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>cumulative_deaths = sum<span style="color: #6c3163;">(</span>cumulative_deaths<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

subset_dnk <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Country.Region == <span style="color: #2d9574;">"Denmark"</span>, Province.State == <span style="color: #2d9574;">""</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>Country.Region, date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>cumulative_deaths = sum<span style="color: #6c3163;">(</span>cumulative_deaths<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

subset_fra <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Country.Region == <span style="color: #2d9574;">"France"</span>, Province.State == <span style="color: #2d9574;">""</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>Country.Region, date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>cumulative_deaths = sum<span style="color: #6c3163;">(</span>cumulative_deaths<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

subset_nld <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Country.Region == <span style="color: #2d9574;">"Netherlands"</span>, Province.State == <span style="color: #2d9574;">""</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>Country.Region, date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>cumulative_deaths = sum<span style="color: #6c3163;">(</span>cumulative_deaths<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

subset_gbr <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Country.Region == <span style="color: #2d9574;">"United Kingdom"</span>, Province.State == <span style="color: #2d9574;">""</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>Country.Region, date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>cumulative_deaths = sum<span style="color: #6c3163;">(</span>cumulative_deaths<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

result_ <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>not<span style="color: #6c3163;">(</span>is.element<span style="color: #2d9574;">(</span>el = Country.Region, set = countries_needing_cleaning<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    select<span style="color: #3a81c3;">(</span>Country.Region, cumulative_deaths, date<span style="color: #3a81c3;">)</span>

result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rbind<span style="color: #3a81c3;">(</span>result_,
                subset_aus,
                subset_can,
                subset_chn,
                subset_dnk,
                subset_fra,
                subset_nld,
                subset_gbr<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    rename<span style="color: #3a81c3;">(</span>location = Country.Region<span style="color: #3a81c3;">)</span>

</pre>
</div>

<p>
Some cruise ship data is scattered throughout the JHU data so this needs to be
filtered out.
</p>

<p>
The JHU data has the cumulative number of deaths in each location on each date,
but we want the actual number of deaths on each day so for each location we
calculate the daily difference in the cumulative number of deaths and use that.
For some days, the cumulative count decreases due to changes in the official
numbers, on these days we set the daily value to zero. Since differencing
reduces the length of a vector by one, we remove the first date from all of the
countries data.
</p>

<div class="org-src-container">
<pre class="src src-R">first_date <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> min<span style="color: #3a81c3;">(</span>result$date<span style="color: #3a81c3;">)</span>

<span style="color: #6c3163; font-weight: bold;">diffed_deaths</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>location_str<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    tmp <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #6c3163;">(</span>result, location == location_str<span style="color: #6c3163;">)</span>
    death_diff <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> diff<span style="color: #6c3163;">(</span>tmp$cumulative_deaths<span style="color: #6c3163;">)</span>
    tmp <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #6c3163;">(</span>tmp, date &gt; first_date<span style="color: #6c3163;">)</span>
    tmp$daily_deaths <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> pmax<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span>, death_diff<span style="color: #6c3163;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span><span style="color: #6c3163;">(</span>tmp<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

location_names <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> unique<span style="color: #3a81c3;">(</span>result$location<span style="color: #3a81c3;">)</span>

diffed_result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> location_names <span style="color: #715ab1;">%&gt;%</span>
    map<span style="color: #3a81c3;">(</span>diffed_deaths<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    bind_rows
</pre>
</div>

<p>
There is a spike in the number of deaths from China on the 17th of April after a
large number of deaths had been added to the official numbers.
</p>

<pre class="example">
&gt; diffed_result %&gt;% filter(location == "China", date &gt; "2020-04-14", date &lt; "2020-04-20")
  location cumulative_deaths       date daily_deaths
1    China              3346 2020-04-15            1
2    China              3346 2020-04-16            0
3    China              4636 2020-04-17         1290
4    China              4636 2020-04-18            0
5    China              4636 2020-04-19            0
&gt; nrow(filter(diffed_result, location == "China", date &lt; "2020-04-17"))
[1] 85
&gt; head(filter(diffed_result, location == "China"))
  location cumulative_deaths       date daily_deaths
1    China                18 2020-01-23            1
2    China                26 2020-01-24            8
3    China                42 2020-01-25           16
4    China                56 2020-01-26           14
5    China                82 2020-01-27           26
6    China               131 2020-01-28           49
</pre>

<p>
We want to account for these deaths, so we will uniformly distribute them over
the previous 85 days in the data set. To see why it is 85 days, recall that the
data only goes back to the 23rd of January. We will use a new variable <code>result</code>
to distinguish between the data frames pre- and post-adjustment.
</p>

<div class="org-src-container">
<pre class="src src-R">result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> diffed_result

result<span style="color: #3a81c3;">[</span>result$location == <span style="color: #2d9574;">"China"</span> &amp; result$date == <span style="color: #2d9574;">"2020-04-17"</span>, <span style="color: #2d9574;">"daily_deaths"</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">0</span>
.mask <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> result$location == <span style="color: #2d9574;">"China"</span> &amp; result$date &lt; <span style="color: #2d9574;">"2020-04-17"</span>
death_adjustment <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">1290</span> / nrow<span style="color: #3a81c3;">(</span>result<span style="color: #6c3163;">[</span>.mask,<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
result<span style="color: #3a81c3;">[</span>.mask, <span style="color: #2d9574;">"daily_deaths"</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> result<span style="color: #3a81c3;">[</span>.mask, <span style="color: #2d9574;">"daily_deaths"</span><span style="color: #3a81c3;">]</span> + death_adjustment
</pre>
</div>

<p>
Then we can do the same check to make sure things looks sensible.
</p>

<pre class="example">
&gt; result %&gt;% filter(location == "China", date &gt; "2020-04-14", date &lt; "2020-04-20")
  location cumulative_deaths       date daily_deaths
1    China              3346 2020-04-15     16.17647
2    China              3346 2020-04-16     15.17647
3    China              4636 2020-04-17      0.00000
4    China              4636 2020-04-18      0.00000
5    China              4636 2020-04-19      0.00000
</pre>

<p>
Since some datasets consider Kosovo as part of Serbia, we will aggregate these
locations in the deaths time series.
</p>

<div class="org-src-container">
<pre class="src src-R">.kosovo_mask <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> result$location == <span style="color: #2d9574;">"Kosovo"</span>
.kosovo_cumulative_deaths <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> result<span style="color: #3a81c3;">[</span>.kosovo_mask, <span style="color: #2d9574;">"cumulative_deaths"</span><span style="color: #3a81c3;">]</span>
.kosovo_daily_deaths <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> result<span style="color: #3a81c3;">[</span>.kosovo_mask, <span style="color: #2d9574;">"daily_deaths"</span><span style="color: #3a81c3;">]</span>
result_rm_kosovo <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>result, location != <span style="color: #2d9574;">"Kosovo"</span><span style="color: #3a81c3;">)</span>
.serbia_mask <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> result_rm_kosovo$location == <span style="color: #2d9574;">"Serbia"</span>
result_rm_kosovo<span style="color: #3a81c3;">[</span>.serbia_mask, <span style="color: #2d9574;">"cumulative_deaths"</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> result_rm_kosovo<span style="color: #3a81c3;">[</span>.serbia_mask, <span style="color: #2d9574;">"cumulative_deaths"</span><span style="color: #3a81c3;">]</span> + .kosovo_cumulative_deaths
result_rm_kosovo<span style="color: #3a81c3;">[</span>.serbia_mask, <span style="color: #2d9574;">"daily_deaths"</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> result_rm_kosovo<span style="color: #3a81c3;">[</span>.serbia_mask, <span style="color: #2d9574;">"daily_deaths"</span><span style="color: #3a81c3;">]</span> + .kosovo_daily_deaths
</pre>
</div>

<p>
Then we save the results to a file <code>output/clean-jhu-deaths.csv</code> for use in the
epidemiological model.
</p>

<div class="org-src-container">
<pre class="src src-R">write.table<span style="color: #3a81c3;">(</span>x = result_rm_kosovo,
            file = <span style="color: #2d9574;">"results/clean-jhu-deaths.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2189a74" class="outline-2">
<h2 id="org2189a74">Cleaning population sizes</h2>
<div class="outline-text-2" id="text-org2189a74">
<p>
The <code>Medium</code> variant of the data corresponds to a sensible choice of
assumptions, more details can be found at the site below
</p>

<p>
<a href="https://population.un.org/wpp/DefinitionOfProjectionVariants/">https://population.un.org/wpp/DefinitionOfProjectionVariants/</a>
</p>

<p>
A suggested citation for this data set can be obtained at the following page
</p>

<p>
<a href="https://population.un.org/wpp/Download/Standard/CSV/">https://population.un.org/wpp/Download/Standard/CSV/</a>
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>

x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/un-population.csv"</span>,
              header = <span style="color: #4e3163;">TRUE</span>,
              stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>Variant == <span style="color: #2d9574;">"Medium"</span>, Time == <span style="color: #4e3163;">2020</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    select<span style="color: #3a81c3;">(</span>Location, PopTotal<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    rename<span style="color: #3a81c3;">(</span>location = Location, population_size = PopTotal<span style="color: #3a81c3;">)</span>

jhu_deaths <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"results/clean-jhu-deaths.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date<span style="color: #6c3163;">)</span>,
           deaths = daily_deaths<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  filter<span style="color: #3a81c3;">(</span>location != <span style="color: #2d9574;">"United Kingdom"</span>,
         location != <span style="color: #2d9574;">"West Bank and Gaza"</span><span style="color: #3a81c3;">)</span>


<span style="color: #6c3163; font-weight: bold;">mutate_location_name</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>df, old_name, new_name<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  mask <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> df$location == old_name
  df<span style="color: #6c3163;">[</span>mask,<span style="color: #2d9574;">"location"</span><span style="color: #6c3163;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> new_name
  <span style="color: #3a81c3; font-weight: bold;">return</span><span style="color: #6c3163;">(</span>df<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Russian Federation"</span>, <span style="color: #2d9574;">"Russia"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Bolivia (Plurinational State of)"</span>, <span style="color: #2d9574;">"Bolivia"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Republic of Korea"</span>, <span style="color: #2d9574;">"Korea, South"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"United States of America"</span>, <span style="color: #2d9574;">"US"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Iran (Islamic Republic of)"</span>, <span style="color: #2d9574;">"Iran"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Brunei Darussalam"</span>, <span style="color: #2d9574;">"Brunei"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"United Republic of Tanzania"</span>, <span style="color: #2d9574;">"Tanzania"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Syrian Arab Republic"</span>, <span style="color: #2d9574;">"Syria"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"China, Taiwan Province of China"</span>, <span style="color: #2d9574;">"Taiwan*"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Venezuela (Bolivarian Republic of)"</span>, <span style="color: #2d9574;">"Venezuela"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Republic of Moldova"</span>, <span style="color: #2d9574;">"Moldova"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Viet Nam"</span>, <span style="color: #2d9574;">"Vietnam"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Myanmar"</span>, <span style="color: #2d9574;">"Burma"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Congo"</span>, <span style="color: #2d9574;">"Congo (Brazzaville)"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Democratic Republic of the Congo"</span>, <span style="color: #2d9574;">"Congo (Kinshasa)"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"C&#244;te d'Ivoire"</span>, <span style="color: #2d9574;">"Cote d'Ivoire"</span><span style="color: #3a81c3;">)</span>
x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">"Lao People's Democratic Republic"</span>, <span style="color: #2d9574;">"Laos"</span><span style="color: #3a81c3;">)</span>

stopifnot<span style="color: #3a81c3;">(</span>length<span style="color: #6c3163;">(</span>setdiff<span style="color: #2d9574;">(</span>jhu_deaths$location, x$location<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #3a81c3;">)</span>

write.table<span style="color: #3a81c3;">(</span>x = x,
            file = <span style="color: #2d9574;">"results/clean-un-population.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org86f7641" class="outline-2">
<h2 id="org86f7641">Cleaning IATA data</h2>
<div class="outline-text-2" id="text-org86f7641">
<p>
Cleaning the IATA data is a little bit tricky because it requires expanding each
record of the original data frame into multiple records in the clean one and
inputting zeros where there are no records of travellers. The resulting code is
very inefficient but only takes a couple of minutes to run so there is not point
in optimising it.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>magrittr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>purrr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>memoise<span style="color: #3a81c3;">)</span>

x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/IATA_CountryLevel_Dec_May.csv"</span>,
              header = <span style="color: #4e3163;">TRUE</span>,
              stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>month != <span style="color: #2d9574;">""</span>, country_origin != <span style="color: #2d9574;">"United Kingdom"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    select<span style="color: #3a81c3;">(</span>country_origin, month, total_volume<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    rename<span style="color: #3a81c3;">(</span>location = country_origin, num_travellers = total_volume<span style="color: #3a81c3;">)</span>


<span style="color: #6c3163; font-weight: bold;">month_total_factory</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #6c3163;">(</span>country_str, month_str<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
        maybe_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
            filter<span style="color: #2d9574;">(</span>location == country_str,
                   grepl<span style="color: #67b11d;">(</span>pattern = month_str, x = month<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #715ab1;">%&gt;%</span>
            use_series<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"num_travellers"</span><span style="color: #2d9574;">)</span>
        <span style="color: #3a81c3; font-weight: bold;">switch</span><span style="color: #2d9574;">(</span>length<span style="color: #67b11d;">(</span>maybe_count<span style="color: #67b11d;">)</span>+<span style="color: #4e3163;">1</span>,
               <span style="color: #4e3163;">0</span>,
               maybe_count,
               <span style="color: #3a81c3; font-weight: bold;">stop</span><span style="color: #67b11d;">(</span><span style="color: #2d9574;">"Bad country and month: "</span>, country_str, month_str<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

month_total <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> month_total_factory<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>
m_month_total <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> memoise<span style="color: #3a81c3;">(</span>month_total<span style="color: #3a81c3;">)</span>

location_names <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> unique<span style="color: #3a81c3;">(</span>x$location<span style="color: #3a81c3;">)</span>
num_locations <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> length<span style="color: #3a81c3;">(</span>location_names<span style="color: #3a81c3;">)</span>

dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seq<span style="color: #3a81c3;">(</span>from = as.Date<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"2019-12-01"</span><span style="color: #6c3163;">)</span>,
             to = as.Date<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"2020-04-30"</span><span style="color: #6c3163;">)</span>,
             by = <span style="color: #4e3163;">1</span><span style="color: #3a81c3;">)</span>


<span style="color: #6c3163; font-weight: bold;">month_global_total_factory</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    month_totals_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
        group_by<span style="color: #6c3163;">(</span>month<span style="color: #6c3163;">)</span> <span style="color: #715ab1;">%&gt;%</span>
        summarise<span style="color: #6c3163;">(</span>total_travellers = sum<span style="color: #2d9574;">(</span>num_travellers<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #6c3163;">(</span>month_str<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
        maybe_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> month_totals_df <span style="color: #715ab1;">%&gt;%</span>
            filter<span style="color: #2d9574;">(</span>grepl<span style="color: #67b11d;">(</span>pattern = month_str, x = month<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #715ab1;">%&gt;%</span>
            use_series<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"total_travellers"</span><span style="color: #2d9574;">)</span>
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>length<span style="color: #67b11d;">(</span>maybe_count<span style="color: #67b11d;">)</span> == <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #3a81c3; font-weight: bold;">return</span><span style="color: #67b11d;">(</span>maybe_count<span style="color: #67b11d;">)</span>
        <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #3a81c3; font-weight: bold;">stop</span><span style="color: #67b11d;">(</span><span style="color: #2d9574;">"Bad month: "</span>, month_str<span style="color: #67b11d;">)</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

month_global_total <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> month_global_total_factory<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>
m_month_global_total <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> memoise<span style="color: #3a81c3;">(</span>month_global_total<span style="color: #3a81c3;">)</span>



<span style="color: #6c3163; font-weight: bold;">record_list</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>country_str, date_obj<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    month_str <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> format<span style="color: #6c3163;">(</span>date_obj, format = <span style="color: #2d9574;">"%b"</span><span style="color: #6c3163;">)</span>

    month_passenger_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> m_month_total<span style="color: #6c3163;">(</span>country_str, month_str<span style="color: #6c3163;">)</span>
    month_total_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> m_month_global_total<span style="color: #6c3163;">(</span>month_str<span style="color: #6c3163;">)</span>

    daily_average <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> month_passenger_count / month_total_count

    data.frame<span style="color: #6c3163;">(</span>location = country_str,
               date = date_obj,
               daily_average = daily_average<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> cross2<span style="color: #3a81c3;">(</span>location_names, dates<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    map<span style="color: #3a81c3;">(</span>lift_dl<span style="color: #6c3163;">(</span>record_list<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span> 
    bind_rows

write.table<span style="color: #3a81c3;">(</span>x = result,
            file = <span style="color: #2d9574;">"results/clean-iata.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org96a45f3" class="outline-2">
<h2 id="org96a45f3">Cleaning Home Office data</h2>
<div class="outline-text-2" id="text-org96a45f3">
<p>
We only need a couple of columns for the Home Office data and that is already in
a reasonably tidy state so it is a simple select and rename.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>

result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/home-office.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>total_air_travels = as.numeric<span style="color: #6c3163;">(</span>gsub<span style="color: #2d9574;">(</span>pattern = <span style="color: #2d9574;">","</span>,
                                               replacement = <span style="color: #2d9574;">""</span>,
                                               x = Total.air.arrivals<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    select<span style="color: #3a81c3;">(</span>Date,total_air_travels<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    rename<span style="color: #3a81c3;">(</span>date = Date<span style="color: #3a81c3;">)</span>

write.table<span style="color: #3a81c3;">(</span>x = result,
            file = <span style="color: #2d9574;">"results/clean-home-office.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org030c1fd" class="outline-2">
<h2 id="org030c1fd">Cleaning non-air travel</h2>
<div class="outline-text-2" id="text-org030c1fd">
<p>
We can re-use a lot of the code from the IATA cleaning script to get a CSV of
the number of passengers arriving via methods other than air.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>reshape2<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>magrittr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>purrr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>memoise<span style="color: #3a81c3;">)</span>

x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/extra-uk-arrivals.csv"</span>, 
              header = <span style="color: #4e3163;">TRUE</span>,
              stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>country = gsub<span style="color: #6c3163;">(</span>pattern = <span style="color: #2d9574;">" total"</span>, replacement = <span style="color: #2d9574;">""</span>, x = X<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    select<span style="color: #3a81c3;">(</span>country, matches<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"*daily"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    melt<span style="color: #3a81c3;">(</span>id.vars = <span style="color: #2d9574;">"country"</span>, variable.name = <span style="color: #2d9574;">"month_var"</span>, value.name = <span style="color: #2d9574;">"daily_count"</span><span style="color: #3a81c3;">)</span>

<span style="color: #6c3163; font-weight: bold;">daily_number_factory</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #6c3163;">(</span>country_str, month_str<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
        maybe_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x <span style="color: #715ab1;">%&gt;%</span>
            filter<span style="color: #2d9574;">(</span>country == country_str,
                   grepl<span style="color: #67b11d;">(</span>pattern = month_str, x = month_var<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #715ab1;">%&gt;%</span>
            use_series<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"daily_count"</span><span style="color: #2d9574;">)</span>
        <span style="color: #3a81c3; font-weight: bold;">switch</span><span style="color: #2d9574;">(</span>length<span style="color: #67b11d;">(</span>maybe_count<span style="color: #67b11d;">)</span>+<span style="color: #4e3163;">1</span>,
               <span style="color: #4e3163;">NA</span>,
               maybe_count,
               <span style="color: #3a81c3; font-weight: bold;">stop</span><span style="color: #67b11d;">(</span><span style="color: #2d9574;">"Bad country and month: "</span>, country_str, month_str<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

daily_number <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> daily_number_factory<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>
m_daily_number <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> memoise<span style="color: #3a81c3;">(</span>daily_number<span style="color: #3a81c3;">)</span>

<span style="color: #6c3163; font-weight: bold;">record_list</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>country_str, date_obj<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    month_str <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> format<span style="color: #6c3163;">(</span>date_obj, format = <span style="color: #2d9574;">"%b"</span><span style="color: #6c3163;">)</span>

    daily_passenger_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> m_daily_number<span style="color: #6c3163;">(</span>country_str, month_str<span style="color: #6c3163;">)</span>


    data.frame<span style="color: #6c3163;">(</span>location = country_str,
               date = date_obj,
               daily_average = daily_passenger_count<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>


location_names <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> unique<span style="color: #3a81c3;">(</span>x$country<span style="color: #3a81c3;">)</span>

dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seq<span style="color: #3a81c3;">(</span>from = as.Date<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"2019-12-01"</span><span style="color: #6c3163;">)</span>,
             to = as.Date<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"2020-04-30"</span><span style="color: #6c3163;">)</span>,
             by = <span style="color: #4e3163;">1</span><span style="color: #3a81c3;">)</span>

result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> cross2<span style="color: #3a81c3;">(</span>location_names, dates<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span> map<span style="color: #3a81c3;">(</span>lift_dl<span style="color: #6c3163;">(</span>record_list<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span> bind_rows

write.table<span style="color: #3a81c3;">(</span>x = result,
            file = <span style="color: #2d9574;">"results/clean-non-air-travel.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb8ca6da" class="outline-2">
<h2 id="orgb8ca6da">Cleaning poverty data I</h2>
<div class="outline-text-2" id="text-orgb8ca6da">
<p>
We extracted Table 1 from Elvidge <i>et al</i> (2009) using <code>tabula-1.2.1</code> and
adjusted the header for clarity. This data was then stored in the file
<code>data/global_population_data/2020-09-07/elvidge2009global.csv</code>. The following
script, <code>clean-elvidge-poverty.R</code>, was then used to further clean this dataset.
</p>

<p>
We define a convenience function for adjusting the names of locations. 
</p>

<div class="org-src-container">
<pre class="src src-mutate-location-name-defnR" id="orgc068ee5">## @@ mutate-location-name-defn @@

mutate_location_name &lt;- function(df, old_name, new_name) {
  mask &lt;- df$location == old_name
  df[mask,"location"] &lt;- new_name
  return(df)
}
</pre>
</div>

<p>
Then we read in the data and adjust some of the location names so that they
match those used in the JHU database.
</p>

<div class="org-src-container">
<pre class="src src-R">poverty_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/elvidge2009global.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  rename<span style="color: #3a81c3;">(</span>location = country<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  select<span style="color: #3a81c3;">(</span>location,
         estimated_percentage_in_poverty<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate_location_name<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"Czech Republic"</span>, <span style="color: #2d9574;">"Czechia"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate_location_name<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"South Korea"</span>, <span style="color: #2d9574;">"Korea, South"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate_location_name<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"United States"</span>, <span style="color: #2d9574;">"US"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate_location_name<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"UAE"</span>, <span style="color: #2d9574;">"United Arab Emirates"</span><span style="color: #3a81c3;">)</span>


write.table<span style="color: #3a81c3;">(</span>x = poverty_df,
            file = <span style="color: #2d9574;">"results/clean-elvidge2009global.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Unfortunately, the Elvidge dataset has some dubious values in it, so we will
primarily use a World Bank dataset that has been curated by Our World in Data.
</p>
</div>
</div>

<div id="outline-container-org8d04bc1" class="outline-2">
<h2 id="org8d04bc1">Cleaning poverty data II</h2>
<div class="outline-text-2" id="text-org8d04bc1">
<p>
The script for cleaning the second set of poverty data is called
 <code>clean-owid-poverty.R</code>
</p>

<p>
Were possible we adjust location names to match those in the JHU dataset. For
locations where there is not a World Bank estimate, we default to the ones from
the previous section.
</p>

<div class="org-src-container">
<pre class="src src-R">poverty_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/share-of-the-population-living-in-extreme-poverty.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  rename<span style="color: #3a81c3;">(</span>location = Entity,
         year = Year,
         poverty_percentage = Share.of.the.population.living.in.extreme.poverty....<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  select<span style="color: #3a81c3;">(</span>location,year,poverty_percentage<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate_location_name<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"Czech Republic"</span>, <span style="color: #2d9574;">"Czechia"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate_location_name<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"South Korea"</span>, <span style="color: #2d9574;">"Korea, South"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate_location_name<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"United States"</span>, <span style="color: #2d9574;">"US"</span><span style="color: #3a81c3;">)</span>


missing_locs <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> setdiff<span style="color: #3a81c3;">(</span>primary_source_locations, poverty_df$location<span style="color: #3a81c3;">)</span>

poverty_elvidge_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"results/clean-elvidge2009global.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  rename<span style="color: #3a81c3;">(</span>poverty_percentage = estimated_percentage_in_poverty<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  filter<span style="color: #3a81c3;">(</span>location <span style="color: #715ab1;">%in%</span> missing_locs<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate<span style="color: #3a81c3;">(</span>year = <span style="color: #4e3163;">2009</span><span style="color: #3a81c3;">)</span>

poverty_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> bind_rows<span style="color: #3a81c3;">(</span>poverty_df, poverty_elvidge_df<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  group_by<span style="color: #3a81c3;">(</span>location<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  summarise<span style="color: #3a81c3;">(</span>latest_poverty_percentage = poverty_percentage<span style="color: #6c3163;">[</span>which.max<span style="color: #2d9574;">(</span>year<span style="color: #2d9574;">)</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>

other_mean <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> poverty_df <span style="color: #715ab1;">%&gt;%</span>
  filter<span style="color: #3a81c3;">(</span>!<span style="color: #6c3163;">(</span>location <span style="color: #715ab1;">%in%</span> primary_source_locations<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  use_series<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"latest_poverty_percentage"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mean
poverty_other_record <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>location = <span style="color: #2d9574;">"other"</span>,
                                   latest_poverty_percentage = other_mean<span style="color: #3a81c3;">)</span>


poverty_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> poverty_df <span style="color: #715ab1;">%&gt;%</span>
  filter<span style="color: #3a81c3;">(</span>location <span style="color: #715ab1;">%in%</span> primary_source_locations<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  bind_rows<span style="color: #3a81c3;">(</span>poverty_other_record<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  as.data.frame

cat<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"clean-owid-poverty.R"</span><span style="color: #3a81c3;">)</span>
setdiff<span style="color: #3a81c3;">(</span>primary_source_locations, poverty_df$location<span style="color: #3a81c3;">)</span>
stopifnot<span style="color: #3a81c3;">(</span>length<span style="color: #6c3163;">(</span>setdiff<span style="color: #2d9574;">(</span>primary_source_locations, poverty_df$location<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>==<span style="color: #4e3163;">0</span><span style="color: #3a81c3;">)</span>


write.table<span style="color: #3a81c3;">(</span>x = poverty_df,
            file = <span style="color: #2d9574;">"results/clean-worldbankpoverty.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org752cde7" class="outline-2">
<h2 id="org752cde7">Estimating number of UK arrivals</h2>
<div class="outline-text-2" id="text-org752cde7">
<p>
To estimate the number of arrivals into the UK from each location, we combine
the data sets and use the formula for each country on each day.
</p>

<p>
\[
\text{arrivals} = \text{proportion IATA} \times \text{Home Office number} + \text{non-air numbers}
\]
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>magrittr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>


iata_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"results/clean-iata.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date, format = <span style="color: #2d9574;">"%Y-%m-%d"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

home_office_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"results/clean-home-office.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date, format = <span style="color: #2d9574;">"%d-%b-%y"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>


iata_and_ho_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> left_join<span style="color: #3a81c3;">(</span>iata_df, home_office_df, by = <span style="color: #2d9574;">"date"</span><span style="color: #3a81c3;">)</span> 

non_air_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"results/clean-non-air-travel.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date, format = <span style="color: #2d9574;">"%Y-%m-%d"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    rename<span style="color: #3a81c3;">(</span>non_air_num = daily_average<span style="color: #3a81c3;">)</span>

all_arrivals_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> left_join<span style="color: #3a81c3;">(</span>iata_and_ho_df, non_air_df<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>non_air_num = ifelse<span style="color: #6c3163;">(</span>test = is.na<span style="color: #2d9574;">(</span>non_air_num<span style="color: #2d9574;">)</span>, yes = <span style="color: #4e3163;">0</span>, no = non_air_num<span style="color: #6c3163;">)</span>,
           estimate = daily_average * total_air_travels + non_air_num<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>!is.na<span style="color: #6c3163;">(</span>estimate<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>


write.table<span style="color: #3a81c3;">(</span>x = all_arrivals_df,
            file = <span style="color: #2d9574;">"results/estimated-arrivals.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a5174a" class="outline-2">
<h2 id="org4a5174a">Estimating the proportion of people capable of seeding a cluster</h2>
<div class="outline-text-2" id="text-org4a5174a">
<p>
Consider a matrix \(A\) where the entry \(A_{i,j}\) is the number of people on
day \(i\) who have a \(j-1\) day old infection. So the first column of \(A\) is
the number of people infected on each day and the final column is the number of
people that die on each day. The upper right corner of the matrix is set to
zero, assuming there where no deaths prior to those in the data and the bottom
left corner is <code>NA</code> because of censoring to the data. The following function
takes a vector of the number of deaths on each day, and the number of days from
infection to death (among those who die from the infection) and returns the
corresponding \(A\) matrix.
</p>

<div class="org-src-container">
<pre class="src src-age-of-infection-matrix-defnR" id="orgb88cf82">## @@ age-of-infection-matrix-defn @@

age_of_infection_matrix &lt;- function(inf_to_death_days, deaths_vector) {
    num_days_in_matrix &lt;- length(deaths_vector) + inf_to_death_days
    result &lt;- matrix(data = NA,
                     nrow = num_days_in_matrix,
                     ncol = inf_to_death_days + 1)

    padded_deaths &lt;- c(rep(0, inf_to_death_days),
                       deaths_vector,
                       rep(NA, inf_to_death_days))

    for (i in 1:num_days_in_matrix) {
        result[i,] &lt;- rev(padded_deaths[i + (0:inf_to_death_days)])
    }

    return(result)
}
</pre>
</div>

<p>
We assume that once someone experiences symptoms, they will not be able to
travel any more. So the people that are capable of seeding a cluster in the UK
are those that are either incubating, or asymptomatic and within the first
\(d_{\text{latent}} + \d_{\text{infectious}}\) days of their infection. So all
of the first \(d_{\text{incubating}} + 1\) columns plus a fraction of the
remaining columns up to \(d_{\text{latent}} + \d_{\text{infectious}} + 1\) make
up the people who could potentially seed a cluster on each day.
</p>

<p>
Since the proportion of asymptomatic infections is very uncertain, we keep this
parameter variable for sensitivity analysis although since most infections
happen earlier it seems that we should opt for a smaller value.
</p>

<p>
The <code>padded_potential_seeders</code> returns a vector of the total number of potential
seeders through time given a vector of the deaths on each day. This pads the
time out in the same way that the age matrix function,
<code>age_of_infection_matrix</code>, result.
</p>

<div class="org-src-container">
<pre class="src src-padded-potential-seeders-defnR" id="org2d33469">## @@ padded-potential-seeders-defn @@

padded_potential_seeders &lt;- function(age_matrix,
                                     days_latent,
                                     days_incubating,
                                     days_infectious,
                                     prop_asymptomatic) {

    presymptomatic_cases &lt;- (age_matrix[,0:days_incubating + 1])
    asymptomatic_cases &lt;- prop_asymptomatic * age_matrix[,(days_incubating + 1):(days_latent + days_infectious) + 1]

    padded_total_seeders &lt;- rowSums(cbind(presymptomatic_cases, asymptomatic_cases))

    return(padded_total_seeders)
}
</pre>
</div>

<p>
Now to actually estimate the proportion of a country's population that could
potentially seed a cluster in the UK, we need the number of covid-19 deaths on
each day in that country the parameters of the infection, and the population of
the country.
</p>

<div class="org-src-container">
<pre class="src src-seeder-proportion-defnR" id="org250bf70">## @@ seeder-proportion-defn @@

seeder_proportion &lt;- function(deaths_df,
                              location_population,
                              days_latent,
                              days_incubating,
                              days_infectious,
                              prop_asymptomatic,
                              days_infection_to_death,
                              infection_fatality_ratio) {
    if (!setequal(names(deaths_df), c("deaths", "date"))) {
        stop("Bad dataframe names: ", names(deaths_df))
    }


    age_matrix &lt;- age_of_infection_matrix(days_infection_to_death, deaths_df$deaths)

    potential_seeders &lt;- padded_potential_seeders(age_matrix,
                                                  days_latent,
                                                  days_incubating,
                                                  days_infectious,
                                                  prop_asymptomatic)

    start_date &lt;- min(deaths_df$date)
    padding_dates &lt;- seq(from = start_date - days_infection_to_death,
                         to = start_date - 1,
                         by = 1)

    total_dates &lt;- c(padding_dates, deaths_df$date)

    data.frame(date = total_dates,
               seeder_proportion = infection_fatality_ratio * potential_seeders / location_population)
}
</pre>
</div>

<p>
Finally, we need to use these functions along with the deaths data and the
population data to estimate the infectious proportion in each country through
time and write all of this to a CSV at the end. The first step is to read in the
data and fix up some discrepencies in location names and define parameters of
covid-19.
</p>

<p>
The JHU data for West Bank and Gaza is removed because it is unclear how it
should be merged into the rest of the data.
</p>

<div class="org-src-container">
<pre class="src src-jhu-un-location-unificationR" id="orgce5c96f">## @@ jhu-un-location-unification @@

library(dplyr)
library(purrr)

jhu_deaths &lt;- read.csv("results/clean-jhu-deaths.csv") %&gt;%
    mutate(date = as.Date(date),
           deaths = daily_deaths) %&gt;%
  filter(location != "United Kingdom",
         location != "West Bank and Gaza")

un_populations &lt;- read.csv("results/clean-un-population.csv")

stopifnot(length(setdiff(jhu_deaths$location, un_populations$location)) == 0)
</pre>
</div>

<p>
When we are estimating the number of people in each state of infection we need
the parameters for the average amount of time people spend in each state. The
following point estimates where derived from parameter values reported in the
literature.
</p>

<ul class="org-ul">
<li>The number of days between symptom onset to death is estimated to be 18 days
<a href="https://doi.org/10.1016/S1473-3099(20)30243-7">https://doi.org/10.1016/S1473-3099(20)30243-7</a></li>
</ul>

<blockquote>
<p>
&#x2026; we estimated the mean duration from onset of symptoms to death to be 178
days (95% credible interval [CrI] 169192)&#x2026;
</p>
</blockquote>

<ul class="org-ul">
<li>The incubation period was assumed to be 5 days
<a href="https://www.nejm.org/doi/full/10.1056/NEJMOa2001316">https://www.nejm.org/doi/full/10.1056/NEJMOa2001316</a></li>
</ul>

<blockquote>
<p>
The mean incubation period was 5.2 days (95% confidence interval [CI], 4.1 to
7.0)&#x2026;
</p>
</blockquote>

<ul class="org-ul">
<li>\(23 = 5 + 18\) so the days from infection to death has a mean of 23 assuming
the duration of the incubation period is independent of the time from symptom
onset to death.</li>

<li>The latent phase was assumemd to finish to finish 2 days before before the
onset of symptoms. In <a href="https://www.nature.com/articles/s41591-020-0869-5">https://www.nature.com/articles/s41591-020-0869-5</a> it was
estimated that although transmission can occur substantially before symptom
onset \(<10\%\) of transmission occurs prior to 3 days before symptom onset,
but likely has a mean closer to 2 days. Since \(3 = 5 - 2\), the days spent
latent is 3.</li>
</ul>

<blockquote>
<p>
&#x2026; start of infectiousness at least 2 days before onset and peak infectiousness at
2 days before to 1 day after onset would be most consistent with this observed
proportion (Extended Data Fig. 3).
</p>
</blockquote>

<ul class="org-ul">
<li>From the same publication, "Infectiousness was estimated to decline quickly
within 7 days.", so given the quote below, we set the number of days for which
an individual is infectious to 7.</li>
</ul>

<blockquote>
<p>
&#x2026;infectiousness may decline significantly 8 days after symptom onset, as live
virus could no longer be cultured (according to W\"{o}lfel and colleagues).
</p>
</blockquote>

<p>
We define variables storing these parameter values.
</p>

<div class="org-src-container">
<pre class="src src-model-parametersR" id="org323c358">## @@ model-parameters @@
days_latent &lt;- 3
days_incubating &lt;- 5
days_infectious &lt;- 7
prop_asymptomatic &lt;- 0.31
days_infection_to_death &lt;- 23
infection_fatality_ratio &lt;- 100
</pre>
</div>

<p>
Then we define a wrapper function that will compute the values for a specific
location based on the <code>un_populations</code> and <code>jhu_deaths</code>, we map this over all
the locations and then bind the results and write them to a CSV:
<code>output/estimated-proportion-seeders.csv</code> for use in subsequent calculations.
</p>

<p>
Note that when reading the population size there is an additional factor of
\(10^3\) because the UN population values are reported in thousands.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">location_seeder_props</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>location_str<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    deaths_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #6c3163;">(</span>jhu_deaths, location == location_str<span style="color: #6c3163;">)</span> <span style="color: #715ab1;">%&gt;%</span>
        select<span style="color: #6c3163;">(</span>date,deaths<span style="color: #6c3163;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>is.element<span style="color: #2d9574;">(</span>location_str, un_populations$location<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
        pop_size <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">1e3</span> * un_populations<span style="color: #2d9574;">[</span>un_populations$location == location_str, <span style="color: #2d9574;">"population_size"</span><span style="color: #2d9574;">]</span>
    <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
        <span style="color: #3a81c3; font-weight: bold;">stop</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"Cannot find a population size for "</span>, location_str<span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">}</span>

    seeder_props <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seeder_proportion<span style="color: #6c3163;">(</span>deaths_df,
                                      pop_size,
                                      days_latent,
                                      days_incubating,
                                      days_infectious,
                                      prop_asymptomatic,
                                      days_infection_to_death,
                                      infection_fatality_ratio<span style="color: #6c3163;">)</span>

    seeder_props$location <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> location_str
    <span style="color: #3a81c3; font-weight: bold;">return</span><span style="color: #6c3163;">(</span>seeder_props<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>


result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> map<span style="color: #3a81c3;">(</span>.x = unique<span style="color: #6c3163;">(</span>jhu_deaths$location<span style="color: #6c3163;">)</span>,
              .f = location_seeder_props<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  bind_rows <span style="color: #715ab1;">%&gt;%</span>
  filter<span style="color: #3a81c3;">(</span>date &lt; <span style="color: #2d9574;">"2020-07-01"</span><span style="color: #3a81c3;">)</span>

stopifnot<span style="color: #3a81c3;">(</span>!any<span style="color: #6c3163;">(</span>is.na<span style="color: #2d9574;">(</span>result$seeder_proportion<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

write.table<span style="color: #3a81c3;">(</span>x = result,
            file = <span style="color: #2d9574;">"results/estimated-proportion-seeders.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We might also be interested in the estimated incidence on each day under this 
method. This is just a simple scaling and transformation of the data, but we do 
it in a similar fashion to the functions above partly as a sanity check on the 
code. Note that because we removed the UK from the <code>jhu_deaths</code> above, this 
result does not include the estimates for the UK; they are drawn from other work
 in our figures.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">location_num_infections</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>location_str<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    deaths_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #6c3163;">(</span>jhu_deaths, location == location_str<span style="color: #6c3163;">)</span> <span style="color: #715ab1;">%&gt;%</span>
        select<span style="color: #6c3163;">(</span>date,deaths<span style="color: #6c3163;">)</span>

    age_matrix <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> age_of_infection_matrix<span style="color: #6c3163;">(</span>days_infection_to_death, deaths_df$deaths<span style="color: #6c3163;">)</span>

    num_deaths_infs <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> age_matrix<span style="color: #6c3163;">[</span>,<span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span>

    start_date <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> min<span style="color: #6c3163;">(</span>deaths_df$date<span style="color: #6c3163;">)</span>
    padding_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seq<span style="color: #6c3163;">(</span>from = start_date - days_infection_to_death,
                         to = start_date - <span style="color: #4e3163;">1</span>,
                         by = <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>

    total_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> c<span style="color: #6c3163;">(</span>padding_dates, deaths_df$date<span style="color: #6c3163;">)</span>

    data.frame<span style="color: #6c3163;">(</span>date = total_dates,
               num_infs = infection_fatality_ratio * num_deaths_infs,
               location = location_str<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> map<span style="color: #3a81c3;">(</span>.x = unique<span style="color: #6c3163;">(</span>jhu_deaths$location<span style="color: #6c3163;">)</span>,
              .f = location_num_infections<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    bind_rows

write.table<span style="color: #3a81c3;">(</span>x = result,
            file = <span style="color: #2d9574;">"results/estimated-daily-infections.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org2f8a07c" class="outline-3">
<h3 id="org2f8a07c">Visualisation (HTML version only)</h3>
<div class="outline-text-3" id="text-org2f8a07c">
<div id="daily-infections"></div>

<script type="text/javascript" src="daily-infections-visualisation.js"></script>
</div>
</div>
</div>

<div id="outline-container-org79ce5d3" class="outline-2">
<h2 id="org79ce5d3">Estimate the introduction index for each of the primary source countries</h2>
<div class="outline-text-2" id="text-org79ce5d3">
<p>
The current data set is unwieldy because there are lots of locations that have a
very low probability of having seeded a cluster. To reduce this, we filter for
those countries that are in the top \(99\%\) of cumulative number of cases at
the start of May; we exclude the UK to capture more of the external pandemic.
</p>

<p>
<code>primary-source-locations-defn</code>
</p>
<div class="org-src-container">
<pre class="src src-primary-source-locations-defnR" id="orgdf5aa67">threshold_date &lt;- as.Date("2020-05-01")
threshold_level &lt;- 0.99

jhu_deaths_df &lt;- read.csv("results/clean-jhu-deaths.csv") %&gt;%
    mutate(date = as.Date(date)) %&gt;%
    filter(location != "United Kingdom")

final_count_df &lt;- jhu_deaths_df %&gt;%
    filter(date == threshold_date) %&gt;%
    rename(final_count = cumulative_deaths)

sorted_final_counts &lt;- sort(final_count_df$final_count, decreasing = TRUE)
cumulative_proportions &lt;- cumsum(sorted_final_counts) / sum(sorted_final_counts)
mask &lt;- cumulative_proportions &lt;= threshold_level
threshold &lt;- min(sorted_final_counts[mask])

primary_source_locations &lt;- final_count_df %&gt;%
    filter(final_count &gt;= threshold) %&gt;%
    use_series("location")
</pre>
</div>

<p>
The threshold is set to 94. Of the 184 locations in the JHU data set (excluding
the UK) 53 contribute 99% of the cumulative cases as of May 1 2020, we
considered these primary sources and aggregated the remaining 131 locations into
a single "other" category.
</p>

<pre class="example">
&gt; print(threshold)
[1] 94
&gt; print(length(primary_source_locations))
[1] 53
&gt; print(length(unique(final_count_df$location)))
[1] 184
&gt; print(length(filter(final_count_df, final_count &lt; threshold)$location))
[1] 131
</pre>

<p>
The file <code>output/estimated-arrivals.csv</code> contains our estimates of the total
number of arrivals into the UK from each country and the file
<code>output/estimated-proportion-seeders.csv</code> contains our estimates of the
proportion of people in each of those countries that could potentially seed a
cluster after coming to the UK. We assume that arrival in the UK is independent
of COVID19 status <i>if you are not symptomatic</i>, which means that the estimate of
the number of people who entered the UK and are capable of seeding a cluster is
just the product of these estimates.
</p>

<div class="org-src-container">
<pre class="src src-R">prop_potential_seeders <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"results/estimated-proportion-seeders.csv"</span>,
                                   stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    dplyr::select<span style="color: #3a81c3;">(</span>date, location, seeder_proportion<span style="color: #3a81c3;">)</span>

stopifnot<span style="color: #3a81c3;">(</span>!any<span style="color: #6c3163;">(</span>is.na<span style="color: #2d9574;">(</span>prop_potential_seeders$seeder_proportion<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
stopifnot<span style="color: #3a81c3;">(</span>all<span style="color: #6c3163;">(</span>intersect<span style="color: #2d9574;">(</span>primary_source_locations, prop_potential_seeders$location<span style="color: #2d9574;">)</span> == primary_source_locations<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"results/estimated-arrivals.csv"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    rename<span style="color: #3a81c3;">(</span>num_arrivals = estimate<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    dplyr::select<span style="color: #3a81c3;">(</span>date, location, num_arrivals<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
There are a lot of locations that are either denoted with different strings 
between the arrivals data and the potential seeders data, so we need to unify 
these where possible, and for cases where there are locations with no matching 
COVID-19 deaths data, those locations need to be removed from the arrivals data.
</p>

<div class="org-src-container">
<pre class="src src-R">&lt;&lt;mutate-location-name-defn&gt;&gt;

estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Czech Republic"</span>, <span style="color: #2d9574;">"Czechia"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"United States"</span>, <span style="color: #2d9574;">"US"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Dominican Rep"</span>, <span style="color: #2d9574;">"Dominican Republic"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Korea (South)"</span>, <span style="color: #2d9574;">"Korea, South"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Antigua-Barbuda"</span>, <span style="color: #2d9574;">"Antigua and Barbuda"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Bosnia-Herzegovina"</span>, <span style="color: #2d9574;">"Bosnia and Herzegovina"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Brunei Darussalam"</span>, <span style="color: #2d9574;">"Brunei"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Cape Verde"</span>, <span style="color: #2d9574;">"Cabo Verde"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Central African Rep"</span>, <span style="color: #2d9574;">"Central African Republic"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Cote D'Ivoire"</span>, <span style="color: #2d9574;">"Cote d'Ivoire"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"St Kitts-Nevis"</span>, <span style="color: #2d9574;">"Saint Kitts and Nevis"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"St Lucia"</span>, <span style="color: #2d9574;">"Saint Lucia"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"St Vincent-Grenad"</span>, <span style="color: #2d9574;">"Saint Vincent and the Grenadines"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Taiwan"</span>, <span style="color: #2d9574;">"Taiwan*"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Trinidad-Tobago"</span>, <span style="color: #2d9574;">"Trinidad and Tobago"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Viet Nam"</span>, <span style="color: #2d9574;">"Vietnam"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Timor-leste"</span>, <span style="color: #2d9574;">"Timor-Leste"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Sao Tome-Principe"</span>, <span style="color: #2d9574;">"Sao Tome and Principe"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mutate_location_name<span style="color: #3a81c3;">(</span>estimated_arrivals, <span style="color: #2d9574;">"Macedonia"</span>, <span style="color: #2d9574;">"North Macedonia"</span><span style="color: #3a81c3;">)</span>

estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Aruba"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Bermuda"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Bonaire, Saint Eustatius and Saba"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Cayman Islands"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Cook Islands"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Curacao"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Falkland Islands"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Faroe Islands"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"French Polynesia"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Gibraltar"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Greenland"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Guadeloupe"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Guam"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Guernsey"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Hong Kong (SAR)"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Isle of Man"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Jersey"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Macao (SAR)"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Martinique"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Mayotte"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Myanmar"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"New Caledonia"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"North Mariana Isl"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Palau"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Puerto Rico"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Reunion"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Samoa"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Solomon Islands"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"St Barthelemy"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"St Helena"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"St Maarten (Dutch Part)"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Svalbard"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Swaziland"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Tonga"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Turkmenistan"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Turks-Caicos"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Vanuatu"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Virgin Islands (GB)"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"Virgin Islands (US)"</span><span style="color: #3a81c3;">)</span>
estimated_arrivals <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #3a81c3;">(</span>estimated_arrivals, location != <span style="color: #2d9574;">"French Guiana"</span><span style="color: #3a81c3;">)</span>

stopifnot<span style="color: #3a81c3;">(</span>all<span style="color: #6c3163;">(</span>intersect<span style="color: #2d9574;">(</span>primary_source_locations, estimated_arrivals$location<span style="color: #2d9574;">)</span> == primary_source_locations<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Then we can combine these to get the estimated number of arriving people 
capable of seeding a cluster. Since the time intervals covered by the different 
data sets do not match up entirely we take their intersection.
</p>

<div class="org-src-container">
<pre class="src src-R">min_date_intersection <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> max<span style="color: #3a81c3;">(</span>min<span style="color: #6c3163;">(</span>estimated_arrivals$date<span style="color: #6c3163;">)</span>, min<span style="color: #6c3163;">(</span>prop_potential_seeders$date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
max_date_intersection <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> min<span style="color: #3a81c3;">(</span>max<span style="color: #6c3163;">(</span>estimated_arrivals$date<span style="color: #6c3163;">)</span>, max<span style="color: #6c3163;">(</span>prop_potential_seeders$date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

seeder_numbers <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> left_join<span style="color: #3a81c3;">(</span>prop_potential_seeders,
                            estimated_arrivals<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate<span style="color: #3a81c3;">(</span>num_seeders = seeder_proportion * num_arrivals<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  filter<span style="color: #3a81c3;">(</span>date &lt;= max_date_intersection, date &gt;= min_date_intersection<span style="color: #3a81c3;">)</span>

.mask <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> is.na<span style="color: #3a81c3;">(</span>seeder_numbers$num_seeders<span style="color: #3a81c3;">)</span>
seeder_numbers<span style="color: #3a81c3;">[</span>.mask, <span style="color: #2d9574;">"num_arrivals"</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">0</span>
seeder_numbers<span style="color: #3a81c3;">[</span>.mask, <span style="color: #2d9574;">"num_seeders"</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">0</span>
</pre>
</div>

<p>
With the relevant locations identified, the seeders can be filtered by an origin
within this set and the the contributions of the remaining locations combined
into an "other" class, the result is the epidemic introduction index.
</p>

<div class="org-src-container">
<pre class="src src-R">eii_data <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seeder_numbers <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>primary_location = ifelse<span style="color: #6c3163;">(</span>test = location <span style="color: #715ab1;">%in%</span> primary_source_locations,
                                     yes = location, no = <span style="color: #2d9574;">"other"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>date,primary_location<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>num_intros = sum<span style="color: #6c3163;">(</span>num_seeders<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>!is.na<span style="color: #6c3163;">(</span>num_intros<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

stopifnot<span style="color: #3a81c3;">(</span>is.element<span style="color: #6c3163;">(</span>el = <span style="color: #2d9574;">"Italy"</span>, set = unique<span style="color: #2d9574;">(</span>eii_data$primary_location<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
stopifnot<span style="color: #3a81c3;">(</span>is.element<span style="color: #6c3163;">(</span>el = <span style="color: #2d9574;">"other"</span>, set = unique<span style="color: #2d9574;">(</span>eii_data$primary_location<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

write.table<span style="color: #3a81c3;">(</span>x = eii_data,
            file = <span style="color: #2d9574;">"results/estimated-introduction-index.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org87aa0d6" class="outline-3">
<h3 id="org87aa0d6">Visualisation (HTML version only)</h3>
<div class="outline-text-3" id="text-org87aa0d6">
<div id="eii"></div>

<script type="text/javascript" src="eii-visualisation.js"></script>

<p>
For this figure to be displayed the CSV file with the EII estimates needs to be
served at <code>http://localhost:8000/results/estimated-introduction-index.csv</code>. Running
<code>python3 -m http.server 8000</code> from the <code>uk-lineages</code> directory should achieve
this.
</p>
</div>
</div>
</div>

<div id="outline-container-orgc880224" class="outline-2">
<h2 id="orgc880224">Estimating the lag distribution I (only simulated data)</h2>
<div class="outline-text-2" id="text-orgc880224">
<p>
We want to study the interval of time between the introduction of an infection
into the UK and the time of the TMRCA of the resulting cluster. To allow us to
estimate this, we make a simplifying assumptions which seem reasonable in the
given setting. We assume the seeding of each cluster is independent of the
seeding of other clusters. This allows us to treat the introduction times as a
sample from the distribution of infection arrival times <i>without replacement</i>.
Since there are far more introductions that clusters this seems like a
reasonable approximation to make.
</p>

<p>
If the introductions are independent, the day \(G\) on which they entered the UK
is drawn from the distribution of daily introductions. Let \(f_G(g)\) be the
probability of the infection being introduced on day \(g\). Then, if the TMRCA
is on day \(k\) there must have been a lag, \(L\) of \(k-g\) days; let
\(f_L(j)\) be the probability of a lag of \(j\) days. So the probability,
\(v_k\), of a TMRCA on day \(k\) is
</p>

<p>
\[
\hat{v}_k := \sum_{g} f_G(g)f_L(k-g)
\]
</p>

<p>
and then \(v = \hat{v} / |\hat{v}|\). Since each TMRCA is independent, the total
likelihood is then just the product of the corresponding \(v_k\) on which they
occurred. We can write a closure for the liklihood function
<code>model_1_llhd_factory</code> which takes a PMF of introductions on each day and the
number of TMRCAs on each day.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">model_1_llhd_factory</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>daily_introduction_prob, daily_tmrca_count<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    stopifnot<span style="color: #6c3163;">(</span>length<span style="color: #2d9574;">(</span>daily_introduction_prob<span style="color: #2d9574;">)</span> == length<span style="color: #2d9574;">(</span>daily_tmrca_count<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    num_days <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> length<span style="color: #6c3163;">(</span>daily_introduction_prob<span style="color: #6c3163;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #6c3163;">(</span>mean_lag<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>mean_lag &gt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            lag_pmf <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> dgeom<span style="color: #67b11d;">(</span>x = <span style="color: #4e3163;">0</span>:<span style="color: #b1951d;">(</span>num_days - <span style="color: #4e3163;">1</span><span style="color: #b1951d;">)</span>, prob = <span style="color: #4e3163;">1</span> / <span style="color: #b1951d;">(</span><span style="color: #4e3163;">1</span> + mean_lag<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

            tmrca_pmf <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> numeric<span style="color: #67b11d;">(</span>num_days<span style="color: #67b11d;">)</span>

            <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #67b11d;">(</span>ix <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #4e3163;">1</span>:num_days<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tmrca_pmf<span style="color: #b1951d;">[</span>ix<span style="color: #b1951d;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> daily_introduction_prob<span style="color: #b1951d;">[</span><span style="color: #4e3163;">1</span>:ix<span style="color: #b1951d;">]</span> <span style="color: #715ab1;">%*%</span> rev<span style="color: #b1951d;">(</span>lag_pmf<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">1</span>:ix<span style="color: #3a81c3;">]</span><span style="color: #b1951d;">)</span>
            <span style="color: #67b11d;">}</span>

            tmrca_pmf <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> tmrca_pmf / sum<span style="color: #67b11d;">(</span>tmrca_pmf<span style="color: #67b11d;">)</span>

            <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">independence assumption</span>
            as.numeric<span style="color: #67b11d;">(</span>daily_tmrca_count <span style="color: #715ab1;">%*%</span> log<span style="color: #b1951d;">(</span>tmrca_pmf<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            -<span style="color: #4e3163;">1e10</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>

<p>
It is well-known that additional sampling of a phylogeny can push the TMRCA
backwards in time closer to the origin of the phylogeny. Hence the TMRCA is
correlated with the size of the reconstructed tree. Because there is no
appreciable depletion of the susceptible proportion, the order of the clusters
should not effect their size. Because we have been watching these clusters until
they have gotten small, there should not be any truncation effects to their
observed size. <span class="underline"><span class="underline">For these reasons we make the simplifying assumption that the
eventual size of the cluster is indepedendent of when it was seeded.</span></span>
</p>
</div>

<div id="outline-container-orged98298" class="outline-3">
<h3 id="orged98298">Simulation study</h3>
<div class="outline-text-3" id="text-orged98298">
<p>
To test that the model we have defined behaves as expected, and that it is
implemented correctly, we simulate a set of <code>num_intros</code> many TMRCA values
conditional upon the EII.
</p>

<div class="org-src-container">
<pre class="src src-R">eii_csv <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #2d9574;">"results/estimated-introduction-index.csv"</span>

x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span>eii_csv, stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>total_intros = sum<span style="color: #6c3163;">(</span>num_intros<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

num_intros <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">1000</span>
intro_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> as.integer<span style="color: #3a81c3;">(</span>x$date - min<span style="color: #6c3163;">(</span>x$date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
intro_dist <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x$total_intros / sum<span style="color: #3a81c3;">(</span>x$total_intros<span style="color: #3a81c3;">)</span>

rand_intro_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> sample<span style="color: #3a81c3;">(</span>intro_dates,
                           size =  num_intros,
                           replace = <span style="color: #4e3163;">TRUE</span>,
                           prob = intro_dist<span style="color: #3a81c3;">)</span>

mean_delay <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">10</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">days</span>
rand_delays <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rgeom<span style="color: #3a81c3;">(</span>n = num_intros, prob = <span style="color: #4e3163;">1</span> - mean_delay / <span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span> + mean_delay<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

rand_tmrcas <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rand_delays + rand_intro_dates
</pre>
</div>

<div class="figure grid-figure">
  <img width=700px src="results/sim-data-fig.png">
</div>

<p>
Then we can take the likelihood function defined above too see who informative
the data is for the mean lag and evaluate it for different values of the mean
lag parameter. The resulting log-likelihood profile is shown in the following
figure. <b>Note</b> that <code>dplyr::full_join</code> will introduce <code>NA</code> s, so we will fill
these in with zero, which is a sensible value in both cases, since the
probability of introduction is very small for those values and in the case of
the TMRCAs, the missing data is literally zero.
</p>

<div class="org-src-container">
<pre class="src src-R">tmrca_table <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> table<span style="color: #3a81c3;">(</span>rand_tmrcas<span style="color: #3a81c3;">)</span>
tmrca_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>day_num = as.integer<span style="color: #6c3163;">(</span>names<span style="color: #2d9574;">(</span>tmrca_table<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>,
                       num_tmrca = as.integer<span style="color: #6c3163;">(</span>tmrca_table<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

intro_probs_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>day_num = intro_dates,
                             intro_prob = intro_dist<span style="color: #3a81c3;">)</span>

sim_data <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> dplyr::full_join<span style="color: #3a81c3;">(</span>intro_probs_df, tmrca_df<span style="color: #3a81c3;">)</span>

na_mask <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> is.na<span style="color: #3a81c3;">(</span>sim_data$num_tmrca<span style="color: #3a81c3;">)</span>
sim_data<span style="color: #3a81c3;">[</span>na_mask,<span style="color: #2d9574;">"num_tmrca"</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">0</span>
<span style="color: #3a81c3;">rm</span><span style="color: #3a81c3;">(</span>na_mask<span style="color: #3a81c3;">)</span>

na_mask <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> is.na<span style="color: #3a81c3;">(</span>sim_data$intro_prob<span style="color: #3a81c3;">)</span>
sim_data<span style="color: #3a81c3;">[</span>na_mask,<span style="color: #2d9574;">"intro_prob"</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">0</span>
<span style="color: #3a81c3;">rm</span><span style="color: #3a81c3;">(</span>na_mask<span style="color: #3a81c3;">)</span>


model_1_llhd <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> model_1_llhd_factory<span style="color: #3a81c3;">(</span>sim_data$intro_prob, sim_data$num_tmrca<span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="figure grid-figure">
  <img width=700px src="results/sim-llhd-fig.png">
</div>
</div>
</div>
</div>

<div id="outline-container-org880a416" class="outline-2">
<h2 id="org880a416">Estimating the lag distribution II (only simulated data)</h2>
<div class="outline-text-2" id="text-org880a416">
<p>
The lag between an arrival of a case into the UK and the observed TMRCA should
decrease with the size of the cluster. However, deriving the distribution of
this lag is difficult so we will settle for a phenomonological description where
the average lag decreases to an asymptote in the size of the cluster. The
functional form is \(\text{lag} = \alpha + \beta/n \) where \(n\) is the size of
the cluster.
</p>

<div class="org-src-container">
<pre class="src src-R">eii_csv <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #2d9574;">"results/estimated-introduction-index.csv"</span>

x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span>eii_csv, stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>date = as.Date<span style="color: #6c3163;">(</span>date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    group_by<span style="color: #3a81c3;">(</span>date<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    summarise<span style="color: #3a81c3;">(</span>total_intros = sum<span style="color: #6c3163;">(</span>num_intros<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

num_intros <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">1000</span>
intro_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> as.integer<span style="color: #3a81c3;">(</span>x$date - min<span style="color: #6c3163;">(</span>x$date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
intro_dist <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> x$total_intros / sum<span style="color: #3a81c3;">(</span>x$total_intros<span style="color: #3a81c3;">)</span>

rand_intro_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> sample<span style="color: #3a81c3;">(</span>intro_dates,
                           size =  num_intros,
                           replace = <span style="color: #4e3163;">TRUE</span>,
                           prob = intro_dist<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The start of the simulation is the same as in the previous example, but now we
need to simulate the size of the cluster prior to simulating the lag.
</p>

<div class="org-src-container">
<pre class="src src-R">mean_size <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">8</span>
rand_sizes <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rgeom<span style="color: #3a81c3;">(</span>n = num_intros,
                    prob = <span style="color: #4e3163;">1</span> - mean_size / <span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span> + mean_size<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> + <span style="color: #4e3163;">2</span>

mean_delay <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">8</span> + <span style="color: #4e3163;">20</span> / rand_sizes
rand_delays <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rgeom<span style="color: #3a81c3;">(</span>n = num_intros,
                     prob = <span style="color: #4e3163;">1</span> - mean_delay / <span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span> + mean_delay<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
rand_tmrcas <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rand_delays + rand_intro_dates

tmrca_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>date = rand_tmrcas,
                       delay = rand_delays,
                       size = rand_sizes<span style="color: #3a81c3;">)</span>
intro_prob_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>date = intro_dates,
                            prob = intro_dist<span style="color: #3a81c3;">)</span>

sim_data <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> dplyr::full_join<span style="color: #3a81c3;">(</span>tmrca_df,
                             intro_prob_df,
                             by = <span style="color: #2d9574;">"date"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The following figure shows both what the raw data looks like as it would be
observed, and the correlation between the hidden delay and the observed cluster
size.
</p>

<div class="figure grid-figure">
  <img width=700px src="results/sim-study-2-fig.png">
</div>

<p>
The definition of the simulated TMRCA values above can be abstracted into the
following function which will be helpful later for model criticism. Note that
one of the parameters to this is a function which returns random sizes, this
will be important later when we want to generate realistic cluster sizes, there
is also the <code>mean_from_size</code> function which requires a specified lag model.
</p>

<p>
<code>r_tmrcas_function</code>
</p>
<div class="org-src-container">
<pre class="src src-r_tmrcas_functionR" id="org210c5c5">#' Return a vector of TMRCA values
#'
#' @param n integer number of TMRCA values
#' @param intro_dates integer vector of dates
#' @param intro_dist numeric vector of date weights
#' @param r_size function which takes an integer and returns that many sizes
#' @param mean_from_size function from size to the mean lag
#'
r_tmrcas &lt;- function(n, intro_dates, intro_dist, r_size, mean_from_size) {
  r_intro_dates &lt;- sample(intro_dates,
                          size = n,
                          replace = TRUE,
                          prob = intro_dist)
  r_sizes &lt;- r_size(n)
  mean_delay &lt;- mean_from_size(r_sizes)
  r_delay &lt;- rgeom(n = n,
                   prob = 1 / (1 + mean_delay))
  return(r_intro_dates + r_delay)
}
</pre>
</div>

<p>
The likelihood for this extended model is very similar, although we need to
disaggregate the data because they now have an additional attribute of cluster
size. This could be made to be a bit more efficient by pre-calculating only the
required values of the log-PMF but this is fast enough for our curren purposes
and is easier to read. We use the <code>log_sum_exp</code> function to avoid underflow. The
functions here are pure which is important because we will want to reuse them
later.
</p>

<p>
<code>llhd_factory</code>
</p>
<div class="org-src-container">
<pre class="src src-llhd_factoryR" id="org2410546">log_sum_exp &lt;- function(x) {
  m &lt;- max(x)
  log(sum(exp(x - m))) + m
}

model_2_llhd_factory &lt;- function(daily_intro_log_probs, tmrca_date, cluster_size) {
    stopifnot(length(tmrca_date) == length(cluster_size))
    stopifnot(max(tmrca_date) &lt;= length(daily_intro_log_probs))
    num_intros &lt;- length(tmrca_date)
    max_possible_lag &lt;- max(tmrca_date)

    function(params) {
        a &lt;- params[1]
        b &lt;- params[2]
        if (min(params) &gt;= 0) {
            llhd &lt;- 0
            mean_lags &lt;- a + b / cluster_size
            for (ix in 1:num_intros) {
                tmrca &lt;- tmrca_date[ix]
                mean_lag &lt;- mean_lags[ix]
                lag_lpmf &lt;- dgeom(x = 0:max_possible_lag,
                                  prob = 1 / (1 + mean_lag),
                                  log = TRUE)
                llhd &lt;- llhd +
                    log_sum_exp(daily_intro_log_probs[1:tmrca] +
                                rev(lag_lpmf[1:tmrca]))
            }
        } else {
            llhd &lt;- - .Machine$double.xmax
        }
        return(llhd)
    }
}
</pre>
</div>

<p>
Then we just need to reshape the data a little bit to be in a form suitables for
using with the resulting <code>llhd</code> function. In doing so we fill in the
introduction probability for very late arrivals with machine epsilon to avoid
numerical issues resulting from taking the log of zero.
</p>

<div class="org-src-container">
<pre class="src src-R">tmrca_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> sim_data <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>not<span style="color: #6c3163;">(</span>is.na<span style="color: #2d9574;">(</span>size<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    use_series<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"date"</span><span style="color: #3a81c3;">)</span>
cluster_sizes <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> sim_data <span style="color: #715ab1;">%&gt;%</span>
    filter<span style="color: #3a81c3;">(</span>not<span style="color: #6c3163;">(</span>is.na<span style="color: #2d9574;">(</span>size<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    use_series<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"size"</span><span style="color: #3a81c3;">)</span>

daily_intro_log_probs <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> dplyr::left_join<span style="color: #3a81c3;">(</span>data.frame<span style="color: #6c3163;">(</span>date = <span style="color: #4e3163;">0</span>:<span style="color: #4e3163;">229</span>,
                                                     dummy = <span style="color: #4e3163;">NA</span><span style="color: #6c3163;">)</span>,
                                          intro_prob_df,
                                          by = <span style="color: #2d9574;">"date"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    mutate<span style="color: #3a81c3;">(</span>safe_prob = ifelse<span style="color: #6c3163;">(</span>test = is.na<span style="color: #2d9574;">(</span>prob<span style="color: #2d9574;">)</span>,
                              yes = .Machine$double.eps,
                              no = prob<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    use_series<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"safe_prob"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    log

model_2_llhd <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> model_2_llhd_factory<span style="color: #3a81c3;">(</span>daily_intro_log_probs,
                                     tmrca_dates,
                                     cluster_sizes<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We numerically estimated the maximum of this likelihood surface using <code>nlm</code>,
starting the algorithm at several intial conditions randomly drawn from an
exponential distribution to test for robustness of the estimate. Note that we
use a log-transform on the parameters to ensure that the values given to the
likelihood function are always positive.
</p>

<p>
<code>numeric-mle</code>
</p>
<div class="org-src-container">
<pre class="src src-numeric-mleR" id="orgf3fb090">estimate_as_df &lt;- function(est) {
  est %&gt;%
    use_series("estimate") %&gt;%
    exp %&gt;%
    set_names(c("alpha", "beta")) %&gt;%
    as.list %&gt;%
    as.data.frame
}

numeric_mle &lt;- 10 %&gt;%
  rerun(log(rexp(n = 2,
                 rate = 1 / c(10, 10)))) %&gt;%
  map(~ nlm(f = function(p) { - model_2_llhd(exp(p)) },
            p = .x)) %&gt;%
  keep(~ .x$code == 1) %&gt;%
  map(estimate_as_df) %&gt;%
  bind_rows
</pre>
</div>

<p>
The function <code>estimate_as_df</code> is a helper function to translate the results of
the minimisation to a record of a data frame. Filtering by the <code>code</code> attribute
is used to ensure that we only record the values where the diagnostics of <code>nlm</code>
are confident that the minima was found.
</p>

<p>
The following figure shows a heatmap of the likelihood surface under the
simulated data. A red circle is used to indicate the true values of the
parameters used to simulate the data.
</p>

<div id="simulation-llhd-heatmap"></div>

<script type="text/javascript" src="results/simulation-llhd-visualisation.js"></script>

<p>
For some bizarre reason, the heatmap breaks, possibly because there are too many
different values being shown, but this figure is buggy in a few ways and could
probably use an overhaul. The geometry is correct, but the implementation is a
bit ugly.
</p>
</div>

<div id="outline-container-org14dfe0e" class="outline-3">
<h3 id="org14dfe0e">Likelihood ratio statistic</h3>
<div class="outline-text-3" id="text-org14dfe0e">
<p>
The null hypothesis is that there is no effect of size on the lag which
corresponds to parameterisations where \(\beta = 0\). Since these are nested
models we can use the likelihood ratio statistic. To test this hypothesis. The
null model has a single parameter \(\alpha\) and the altertivative model has two
\((\alpha,\beta)\), hence the likelihood ratio statistic has a chi-squared
distribution with a single degree of freedom. We can numerically estiamte the
MLE and run the calculation for the <i>p</i>-value of the null.
</p>

<p>
<code>llhd-ratio-statistic</code>
</p>
<div class="org-src-container">
<pre class="src src-llhd-ratio-statisticR" id="orga635cb5">null_obj &lt;- function(p) { - model_2_llhd(c(exp(p), 0)) }
null_est &lt;- nlm(f = null_obj, p = rnorm(1))
if (null_est$code == 1) {
  null_llhd &lt;- - null_est$minimum
} else {
  stop("Optimisation non-unit code.")
}

altr_obj &lt;- function(p) { - model_2_llhd(exp(p)) }
altr_est &lt;- nlm(f = altr_obj, p = rnorm(2))
if (altr_est$code == 1) {
  altr_llhd &lt;- - altr_est$minimum
} else {
  stop("Optimisation non-unit code.")
}


llhd_ratio_stat &lt;- 2 * (altr_llhd - null_llhd)
p_val &lt;- pchisq(q = llhd_ratio_stat,
                df = 1, lower.tail = FALSE)

cat("The null LLHD is ", null_llhd, " at ", exp(null_est$estimate), "\n",
    "The alternative LLHD is ", altr_llhd, " at ", exp(altr_est$estimate), "\n",
    "The likelihood ratio statistic is ", llhd_ratio_stat, "with 1 degree of freedom\n",
    "the p-value is ", p_val, "\n")
</pre>
</div>

<p>
Which when run prints out the following&#x2026;
</p>

<pre class="example">
The null LLHD is  -4204.266  at  11.65166 
 The alternative LLHD is  -4184.053  at  7.164843 24.13244 
 The likelihood ratio statistic is  40.42582 with 1 degree of freedom
 the p-value is  2.042247e-10 
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb04aeae" class="outline-2">
<h2 id="orgb04aeae">Estimating the lag distribution III (thresholded MCC tree)</h2>
<div class="outline-text-2" id="text-orgb04aeae">
<p>
This section looks at estimating the lag model from the MCC tree data which has
been tresholded at a 0.5 level.
</p>

<p>
The implementation of the likelihood above assumed that the dates where encoded
as integers, so we define a helper function to convert the dates to integers
describing the day of the year, although we have to be careful to check that all
the relevant dates fall in the year 2020 unless we want to deal with modular
arithmetic. <b>Note</b> this function is vectorised so you can apply it to a vector
of date objects.
</p>

<p>
<code>date-as-day-of-year-function</code>
</p>
<div class="org-src-container">
<pre class="src src-date-as-day-of-year-functionR" id="orgd80812f">date_as_day_of_year &lt;- function(date_objs) {
  as.integer(format.Date(date_objs, "%j"))
}
</pre>
</div>

<p>
We read in the EII data and extend it to capture the whole range of TMRCA dates
setting setting the introductions numbers to 0 on days far enough in the future
that interventions would have made the chance of additional introductions
negligable.
</p>

<p>
<code>eii-setup-1</code>
</p>
<div class="org-src-container">
<pre class="src src-eii-setup-1R" id="org1c64c91">&lt;&lt;date-as-day-of-year-function&gt;&gt;

eii_csv &lt;- "results/estimated-introduction-index.csv"
eii_df &lt;- read.csv(eii_csv,
                   stringsAsFactors = FALSE) %&gt;%
    mutate(date = as.Date(date)) %&gt;%
    group_by(date) %&gt;%
    summarise(total_intros = sum(num_intros))

tmrca_date_range &lt;- as.Date(c("2020-01-01", "2020-06-30"))
eii_eps &lt;- data.frame(date = seq(from = tmrca_date_range[1],
                                 to = tmrca_date_range[2],
                                 by = 1))

eii_df &lt;- full_join(eii_df, eii_eps, by = "date")
eii_df[is.na(eii_df$total_intros),]$total_intros &lt;- 0
</pre>
</div>

<p>
We further process the EII data to construct the daily introduction
probabilities. Then we construct the vectors of data that are expected by the
LLHD function. The zeros we added before will now need to be handled slightly
differently (i.e., we use machine precision to replace zero,) to ensure that we
don't get infinite values causing numerical issues later.
</p>

<p>
<code>eii-setup-2</code>
</p>
<div class="org-src-container">
<pre class="src src-eii-setup-2R" id="org7d4164f">intro_dates &lt;- eii_df$date
intro_date_nums &lt;- date_as_day_of_year(eii_df$date)
intro_dist &lt;- eii_df$total_intros / sum(eii_df$total_intros)

intro_prob_df &lt;- data.frame(date = intro_dates,
                            date_num = intro_date_nums,
                            prob = intro_dist)

daily_intro_log_probs &lt;- log(intro_prob_df$prob)
.inf_mask &lt;- is.infinite(daily_intro_log_probs)
daily_intro_log_probs[.inf_mask] &lt;- .Machine$double.min.exp
</pre>
</div>

<p>
The data of the cluster TMRCA values is stored in the file
<code>data/phylogenetics_data/2020-09-14/clusters_DTA_MCC_0.5.csv</code>. This file
contains only a point estimate of cluster sizes. There are a couple of
assertions here to ensure that the EII does encompass all of the TMRCA dates.
</p>

<div class="org-src-container">
<pre class="src src-R">cluster_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/clusters_DTA_MCC_0.5.csv"</span>,
                       stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate<span style="color: #3a81c3;">(</span>tmrca_date = as.Date<span style="color: #6c3163;">(</span>tmrca_calendar<span style="color: #6c3163;">)</span>,
         date_num = date_as_day_of_year<span style="color: #6c3163;">(</span>tmrca_date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  select<span style="color: #3a81c3;">(</span>cluster, seqs, tmrca_date, date_num<span style="color: #3a81c3;">)</span>

stopifnot<span style="color: #3a81c3;">(</span>min<span style="color: #6c3163;">(</span>eii_df$date<span style="color: #6c3163;">)</span> &gt;= as.Date<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"2020-01-01"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
stopifnot<span style="color: #3a81c3;">(</span>min<span style="color: #6c3163;">(</span>eii_df$date<span style="color: #6c3163;">)</span> &lt;= min<span style="color: #6c3163;">(</span>cluster_df$tmrca_date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
stopifnot<span style="color: #3a81c3;">(</span>max<span style="color: #6c3163;">(</span>eii_df$date<span style="color: #6c3163;">)</span> &gt;= max<span style="color: #6c3163;">(</span>cluster_df$tmrca_date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The vectors <code>tmrca_dates</code> and <code>cluster_sizes</code> are the actual data we need
regarding the clusters to specify the likelihood function.
</p>

<div class="org-src-container">
<pre class="src src-R">tmrca_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> cluster_df$date_num
cluster_sizes <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> cluster_df$seqs
</pre>
</div>

<p>
We then define the same likelihood function as from the previous simulation
study &#x2014; this is done by the NOWEB syntax <code>&lt;&lt;llhd_factory&gt;&gt;</code> which pulls in the
<code>model_2_llhd_factory</code> function from above.
</p>

<div class="org-src-container">
<pre class="src src-R">&lt;&lt;llhd_factory&gt;&gt;

model_2_llhd <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> model_2_llhd_factory<span style="color: #3a81c3;">(</span>daily_intro_log_probs,
                                     tmrca_dates,
                                     cluster_sizes<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Then we evaluated the log-likelihood function on a mesh of values of \(\alpha\)
and \(\beta\) to generate a heatmap of the likelihood surface. As expected,
there is a tradeoff between \(\alpha\) and \(\beta\) which we had seen in the
previous heatmap.
</p>

<div id="lag-llhd-heatmap"></div>

<script type="text/javascript">
var lagLlhdHeatmap = "http://localhost:8000/lag-estimation-llhd-heatmap.json";
vegaEmbed('#lag-llhd-heatmap', lagLlhdHeatmap).then(function(result) {
}).catch(console.error);
</script>

<p>
We can then use the same snippets from above to estimate the MLE and to perform
the LRT for \(\beta = 0\).
</p>

<div class="org-src-container">
<pre class="src src-R">&lt;&lt;numeric-mle&gt;&gt;

write.table<span style="color: #3a81c3;">(</span>x = numeric_mle,
            file = <span style="color: #2d9574;">"results/lag-estimate-mle-estimates.csv"</span>,
            quote = <span style="color: #4e3163;">FALSE</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>

sink<span style="color: #3a81c3;">(</span>file = <span style="color: #2d9574;">"results/llhd-ratio-report-lag-estimate.txt"</span><span style="color: #3a81c3;">)</span>

&lt;&lt;llhd-ratio-statistic&gt;&gt;

sink<span style="color: #3a81c3;">()</span>
</pre>
</div>

<p>
The <code>sink</code> command pipes the output of the likelihood ratio test to a file that
can then be included in the output. Based on this we see that there is a
substantial difference in the likelihood between the two models, but with the
parameters so close to the edge of the parameter space we might need to be a
little bit careful not to overinterpret the <i>p</i>-value of the results.
</p>

<pre class="example">
The null LLHD is  -4813.221  at  8.21118 
 The alternative LLHD is  -4744.612  at  0.7190474 28.91352 
 The likelihood ratio statistic is  137.2184 with 1 degree of freedom
 the p-value is  1.080251e-31 
</pre>

<p>
Another method would be to use the AIC as a model selection method. Since the
log-likelihood differs be about \(67\) and there is only a single parameter
difference, this still gives very good support for the model with \(\beta \neq
0\).
</p>

<p>
To check that the optimisation has landed at a sensible place, we can compute
the log-likelihood profiles about the optima.
</p>

<div class="org-src-container">
<pre class="src src-R">mle_estimate <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> exp<span style="color: #3a81c3;">(</span>altr_est$estimate<span style="color: #3a81c3;">)</span>

mesh_length <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">50</span>

alpha_mesh <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seq<span style="color: #3a81c3;">(</span>from = <span style="color: #4e3163;">0</span>, to = mle_estimate<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> * <span style="color: #4e3163;">2</span>, length = mesh_length<span style="color: #3a81c3;">)</span>
alpha_profile <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> alpha_mesh <span style="color: #715ab1;">%&gt;%</span> map<span style="color: #3a81c3;">(</span>~ model_2_llhd<span style="color: #6c3163;">(</span>c<span style="color: #2d9574;">(</span>.x, mle_estimate<span style="color: #67b11d;">[</span><span style="color: #4e3163;">2</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span> as_vector

beta_mesh <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seq<span style="color: #3a81c3;">(</span>from = <span style="color: #4e3163;">0</span>, to = mle_estimate<span style="color: #6c3163;">[</span><span style="color: #4e3163;">2</span><span style="color: #6c3163;">]</span> * <span style="color: #4e3163;">2</span>, length = mesh_length<span style="color: #3a81c3;">)</span>
beta_profile <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> beta_mesh <span style="color: #715ab1;">%&gt;%</span> map<span style="color: #3a81c3;">(</span>~ model_2_llhd<span style="color: #6c3163;">(</span>c<span style="color: #2d9574;">(</span>mle_estimate<span style="color: #67b11d;">[</span><span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span>, .x<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span> as_vector

result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>param = rep<span style="color: #6c3163;">(</span>c<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"alpha"</span>, <span style="color: #2d9574;">"beta"</span><span style="color: #2d9574;">)</span>, each = mesh_length<span style="color: #6c3163;">)</span>,
                     value = c<span style="color: #6c3163;">(</span>alpha_mesh, beta_mesh<span style="color: #6c3163;">)</span>,
                     llhd = c<span style="color: #6c3163;">(</span>alpha_profile, beta_profile<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

write.table<span style="color: #3a81c3;">(</span>result,
            file = <span style="color: #2d9574;">"results/lag-estimate-llhd-profiles.csv"</span>,
            quote = <span style="color: #4e3163;">FALSE</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
To check what the model fit actually looks like, we have the following code
which estimates the 95% CI for when the introduction may have occurred.
</p>

<div class="org-src-container">
<pre class="src src-R">model_criticism_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>cluster_size = cluster_sizes,
                                 tmrca_date = tmrca_dates,
                                 mean_lag_estimate = median<span style="color: #6c3163;">(</span>numeric_mle$alpha<span style="color: #6c3163;">)</span> + median<span style="color: #6c3163;">(</span>numeric_mle$beta<span style="color: #6c3163;">)</span> / cluster_sizes<span style="color: #3a81c3;">)</span>
sorted_ixs <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> order<span style="color: #3a81c3;">(</span>model_criticism_df$tmrca_date, model_criticism_df$cluster_size<span style="color: #3a81c3;">)</span>
model_criticism_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> model_criticism_df<span style="color: #3a81c3;">[</span>sorted_ixs,<span style="color: #3a81c3;">]</span>
model_criticism_df$ix = <span style="color: #4e3163;">1</span>:nrow<span style="color: #3a81c3;">(</span>model_criticism_df<span style="color: #3a81c3;">)</span>
model_criticism_df$lag_lower_bound <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> qgeom<span style="color: #3a81c3;">(</span>p = <span style="color: #4e3163;">0.025</span>, prob = <span style="color: #4e3163;">1</span> / <span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span> + model_criticism_df$mean_lag_estimate<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
model_criticism_df$lag_upper_bound <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> qgeom<span style="color: #3a81c3;">(</span>p = <span style="color: #4e3163;">0.975</span>, prob = <span style="color: #4e3163;">1</span> / <span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span> + model_criticism_df$mean_lag_estimate<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>


write.table<span style="color: #3a81c3;">(</span>x = model_criticism_df,
            file = <span style="color: #2d9574;">"results/lag-estimate-model-fig.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The second figure shows the TMRCA of each cluster ordered by date with size and
colour mapping to the size of the cluster, the line segments next to each point
indicate the 95% CI of the estimate for when that cluster was introduced into
the UK.
</p>

<div id="lag-llhd-profile"></div>

<div id="lag-model-pred"></div>

<script type="text/javascript">
var lagLlhdProfiles = "http://localhost:8000/lag-estimate-llhd-profiles.json";
vegaEmbed('#lag-llhd-profile', lagLlhdProfiles).then(function(result) {
}).catch(console.error);

var lagModelPred = "http://localhost:8000/lag-estimate-model-fig.json";
vegaEmbed('#lag-model-pred', lagModelPred).then(function(result) {
}).catch(console.error);
</script>

<p>
A more nuanced way to test the legitemacy of the model is to look at simulated
TMRCA values under the model fit to see if they obviously different from the
actual data set. Using the <code>r_tmrcas</code> function from before we can generate 19
replicates of the data under the fitted model. Note that to generate the cluster
sizes we are just resampling from the distribution.
</p>

<div class="org-src-container">
<pre class="src src-R">&lt;&lt;r_tmrcas_function&gt;&gt;

<span style="color: #6c3163; font-weight: bold;">r_size</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>n<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  sample<span style="color: #6c3163;">(</span>x = cluster_sizes, size = n, replace = <span style="color: #4e3163;">TRUE</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #6c3163; font-weight: bold;">mean_from_size_factory</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>alpha, beta<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #6c3163;">(</span>c_size<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    alpha + beta / c_size
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

mean_from_size <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mean_from_size_factory<span style="color: #3a81c3;">(</span>median<span style="color: #6c3163;">(</span>numeric_mle$alpha<span style="color: #6c3163;">)</span>, 
                                         median<span style="color: #6c3163;">(</span>numeric_mle$beta<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

replicated_tmrca_sampes <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rerun<span style="color: #3a81c3;">(</span>.n = <span style="color: #4e3163;">19</span>, 
                                 r_tmrcas<span style="color: #6c3163;">(</span>length<span style="color: #2d9574;">(</span>cluster_sizes<span style="color: #2d9574;">)</span>,
                                          intro_date_nums,
                                          intro_dist,
                                          r_size,
                                          mean_from_size<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>


<p>
The next step is to generate the figure of the TMRCAs to see how they compare to
the actual values, any discrepencies are an indication of a deficiency of the
model. There is a slight difference, but it is not a huge difference and this
could be an artifact of the binning used.
</p>

<div class="org-src-container">
<pre class="src src-R">foo <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> c<span style="color: #3a81c3;">(</span>list<span style="color: #6c3163;">(</span>tmrca_dates<span style="color: #6c3163;">)</span>, replicated_tmrca_sampes<span style="color: #3a81c3;">)</span>
bar <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> as.list<span style="color: #3a81c3;">(</span>c<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"truth"</span>, rep<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"simulation"</span>, <span style="color: #4e3163;">19</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
baz <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> as.list<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">1</span>:<span style="color: #4e3163;">20</span><span style="color: #3a81c3;">)</span>

plot_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> map3<span style="color: #3a81c3;">(</span>foo,
                bar,
                baz,
                <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #6c3163;">(</span>x,y,z<span style="color: #6c3163;">)</span> data.frame<span style="color: #6c3163;">(</span>tmrca = x,
                                           model = y,
                                           id = z<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span> 
  bind_rows

write.table<span style="color: #3a81c3;">(</span>x = plot_df,
            file = <span style="color: #2d9574;">"results/lag-estimation-tmrca-replicates.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div id="lag-tmrca-replicates"></div>


<script type="text/javascript">
var lagTMRCAReplicates = "http://localhost:8000/lag-estimate-tmrca-replicates.json";
vegaEmbed('#lag-tmrca-replicates', lagTMRCAReplicates).then(function(result) {
}).catch(console.error);

</script>
</div>
</div>

<div id="outline-container-orgbed7b75" class="outline-2">
<h2 id="orgbed7b75">Estimating the lag distribution IV (simulation re-estimation)</h2>
<div class="outline-text-2" id="text-orgbed7b75">
<p>
Now that we have an estimate of the parameters we can performa a simulation
re-estimation study to obtain a CI and get a better understanding of the lag
model. The script that will contain this analysis is <code>simulation-study-3.R</code>.
Most of the necessary code can be re-used from previous parts of this document.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>purrr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>magrittr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>ggplot2<span style="color: #3a81c3;">)</span>

&lt;&lt;llhd_factory&gt;&gt;

&lt;&lt;r_tmrcas_function&gt;&gt;

&lt;&lt;eii-setup-<span style="color: #4e3163;">1</span>&gt;&gt;

&lt;&lt;eii-setup-<span style="color: #4e3163;">2</span>&gt;&gt;
</pre>
</div>

<p>
However, we do need a way to select random cluster sizes. Rather than
approximating the distribution, we will just re-sample the existing cluster
sizes. The <code>r_cluster_sizes</code> function takes no arguments and returns a vector of
cluster sizes.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">r_cluster_sizes_factory</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>cluster_sizes<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  num_clusters <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> length<span style="color: #6c3163;">(</span>cluster_sizes<span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #6c3163;">()</span> <span style="color: #6c3163;">{</span>
  sample<span style="color: #2d9574;">(</span>cluster_sizes,
         size = num_clusters,
         replace = <span style="color: #4e3163;">TRUE</span><span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

data_file <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #2d9574;">"../../data/epidemiological/clusters_DTA_MCC_0.5.csv"</span>

r_cluster_sizes <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span>data_file,
                            stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate<span style="color: #3a81c3;">(</span>tmrca_date = as.Date<span style="color: #6c3163;">(</span>tmrca_calendar<span style="color: #6c3163;">)</span>,
         date_num = date_as_day_of_year<span style="color: #6c3163;">(</span>tmrca_date<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  use_series<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"seqs"</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  r_cluster_sizes_factory
</pre>
</div>

<p>
The <code>mean_from_size_factory</code> is there as a convenient way for us to generate the
expected lag for each of the simulated data sets. We can generate the actual
<code>mean_from_size</code> function by plugging in our previous estimate.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">mean_from_size_factory</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>alpha, beta<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #6c3163;">(</span>c_size<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    alpha + beta / c_size
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

mean_from_size <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> mean_from_size_factory<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">0.7189865</span>, <span style="color: #4e3163;">28.91369</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
This provides us with all the components to generate multiple random data sets,
construct their likelihood functions so we just need a function to numerically
approximate the MLE and we will have all the components for the simulation
re-estimation study. The <code>random_reestimate</code> function generates a random data
set and then attempts to compute the MLE.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">estimate_as_df</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>est<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  data.frame<span style="color: #6c3163;">(</span>alpha = exp<span style="color: #2d9574;">(</span>est$estimate<span style="color: #67b11d;">[</span><span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>,
             beta = exp<span style="color: #2d9574;">(</span>est$estimate<span style="color: #67b11d;">[</span><span style="color: #4e3163;">2</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>,
             exit_code = est$code<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #6c3163; font-weight: bold;">random_reestimate</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  foo_n <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> length<span style="color: #6c3163;">(</span>raw_cluster_sizes<span style="color: #6c3163;">)</span>

  valid_sim <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">FALSE</span>
  loop_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">0</span>
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>not<span style="color: #2d9574;">(</span>valid_sim<span style="color: #2d9574;">)</span> &amp;&amp; loop_count &lt; <span style="color: #4e3163;">20</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    foo_sizes <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> r_cluster_sizes<span style="color: #2d9574;">()</span>
    foo_tmrca_dates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> r_tmrcas<span style="color: #2d9574;">(</span>foo_n,
                                intro_dates,
                                intro_dist,
                                <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #67b11d;">(</span>dummy<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>foo_sizes<span style="color: #67b11d;">}</span>,
                                mean_from_size<span style="color: #2d9574;">)</span> <span style="color: #715ab1;">%&gt;%</span>
      date_as_day_of_year
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>max<span style="color: #67b11d;">(</span>foo_tmrca_dates<span style="color: #67b11d;">)</span> &lt;= length<span style="color: #67b11d;">(</span>daily_intro_log_probs<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      valid_sim <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">TRUE</span>
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
      loop_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> loop_count + <span style="color: #4e3163;">1</span>
      <span style="color: #3a81c3;">warning</span><span style="color: #67b11d;">(</span><span style="color: #2d9574;">"failed simulation..."</span><span style="color: #67b11d;">)</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>valid_sim<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    foo_llhd <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> model_2_llhd_factory<span style="color: #2d9574;">(</span>daily_intro_log_probs,
                                     foo_tmrca_dates,
                                     foo_sizes<span style="color: #2d9574;">)</span>

    <span style="color: #6c3163; font-weight: bold;">foo_obj</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #2d9574;">(</span>p<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> - foo_llhd<span style="color: #67b11d;">(</span>exp<span style="color: #b1951d;">(</span>p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #2d9574;">}</span>
    foo_est <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> nlm<span style="color: #2d9574;">(</span>f = foo_obj, p = rnorm<span style="color: #67b11d;">(</span><span style="color: #4e3163;">2</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    estimate_as_df<span style="color: #2d9574;">(</span>foo_est<span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    data.frame<span style="color: #2d9574;">(</span>alpha = <span style="color: #4e3163;">NA</span>, beta = <span style="color: #4e3163;">NA</span>, exit_code = <span style="color: #4e3163;">5</span><span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>

<p>
Then we just need to re-evaluate this expression and write the results to file.
The exit code of the optimisation can be mapped to the colour of points to make
sure no bad results slipped in.
</p>

<div class="org-src-container">
<pre class="src src-R">num_replicates <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">100</span>
plot_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rerun<span style="color: #3a81c3;">(</span>.n = num_replicates, random_reestimate<span style="color: #6c3163;">()</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  bind_rows

write.table<span style="color: #3a81c3;">(</span>x = plot_df,
            file = <span style="color: #2d9574;">"results/sim-study-3-reestimates.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div id="sim-study-3-reestimates"></div>

<script type="text/javascript">
var simStudy3Reestimates = "http://localhost:8000/sim-study-3-reestimates.json";
vegaEmbed('#sim-study-3-reestimates', simStudy3Reestimates).then(function(result) {
}).catch(console.error);
</script>
</div>
</div>

<div id="outline-container-orgfcde86c" class="outline-2">
<h2 id="orgfcde86c">Estimating the lag distribution V (variable threshold MCC tree)</h2>
<div class="outline-text-2" id="text-orgfcde86c">
<p>
There is uncertainty in the estimated TMRCA dates and cluster sizes. The file
<code>data/phylogenetics_data/2020-09-14/clusters_DTA_MCC.csv</code> contains estimates
obtained by altering a threshold parameter in the MCC tree. To understand how
the uncertainty propagates we want to estimate \(\alpha\) and \(\beta\) for each
of these estimates. The script that will contain this analysis is
<code>lag-estimation-2.R</code>, most of required code can be reused from the previous
analysis.
</p>

<p>
<code>eii-and-llhd-setup</code>
</p>
<div class="org-src-container">
<pre class="src src-eii-and-llhd-setupR" id="orga447cc7">&lt;&lt;eii-setup-1&gt;&gt;

&lt;&lt;eii-setup-2&gt;&gt;

&lt;&lt;llhd_factory&gt;&gt;
</pre>
</div>

<p>
The schema of the data is the same in <code>clusters_DTA_MCC_0.5.csv</code> but now we also
select for the <code>cutoff</code> variable to indicate which threshold was used for those
cluster sizes and TMRCAs.
</p>

<p>
<code>read-in-all-mcc-cluster-data</code>
</p>
<div class="org-src-container">
<pre class="src src-read-in-all-mcc-cluster-dataR" id="orgade62d9">all_clusters_df &lt;- read.csv("../../data/epidemiological/clusters_DTA_MCC.csv",
                            stringsAsFactors = FALSE) %&gt;%
  mutate(tmrca_date = as.Date(tmrca_calendar),
         date_num = date_as_day_of_year(tmrca_date),
         cutoff = as.factor(cutoff)) %&gt;%
  select(cluster, seqs, tmrca_date, date_num, cutoff)
</pre>
</div>

<p>
To get the LLHD function for each cutoff value, we need to extract the relevant
cluster size data and give it to <code>model_2_llhd_factory</code> along with the daily
introduction probabilities. The following function does this and wraps up the
result with the cutoff value of the data used. The assertions have been
duplicated from previous source blocks.
</p>

<p>
<code>llhd-factory-applier-defn</code>
</p>
<div class="org-src-container">
<pre class="src src-llhd-factory-applier-defnR" id="org2b835ec">llhd_factory_applier &lt;- function(cutoff_factor, all_clusters_df,
                                 daily_intro_log_probs, eii_df) {
  cluster_df &lt;- filter(.data = all_clusters_df,
                       cutoff == cutoff_factor)

  stopifnot(nrow(cluster_df) &gt; 0)
  stopifnot(min(eii_df$date) &gt;= as.Date("2020-01-01"))
  stopifnot(min(eii_df$date) &lt;= min(cluster_df$tmrca_date))
  stopifnot(max(eii_df$date) &gt;= max(cluster_df$tmrca_date))

  list(llhd_func = model_2_llhd_factory(daily_intro_log_probs,
                                        cluster_df$date_num,
                                        cluster_df$seqs),
       cutoff = cutoff_factor)
}
</pre>
</div>

<p>
To actually estimate the MLE for these LLHD functions we re-use some of the code
from <code>&lt;&lt;numeric-mle&gt;&gt;</code>, throwing a warning if the numeric optimisation failed
(which may have occurred if the exit code exceeds 2). We record the resuls along
with the exit code for post processing. Note that this uses a transform on the
parameter space to make things easier for the optimisation algorithm and it
starts with a random initial condition.
</p>

<p>
<code>estimate-mle-defn</code>
</p>
<div class="org-src-container">
<pre class="src src-estimate-mle-defnR" id="org69e4c63">estimated_mle &lt;- function(llhd_obj) {
  stopifnot(setequal(names(llhd_obj),
                     c("llhd_func", "cutoff")))

  p0 &lt;- rnorm(n = 2)

  .f &lt;- function(p) {
    - llhd_obj$llhd_func(exp(p))
  }

  est &lt;- nlm(f = .f, p = p0)

  result &lt;- est$estimate %&gt;%
    exp %&gt;%
    set_names(c("alpha", "beta")) %&gt;%
    as.list
  result$cutoff &lt;- llhd_obj$cutoff
  result$llhd &lt;- - est$minimum

  if (est$code &gt; 2) {
    warning("Inference failed for cutoff: ",
            result$cutoff)
  }

  result$exit_code &lt;- est$code
  return(result)
}
</pre>
</div>

<p>
Finally, we map these functions over the cluster data for all of the cutoff
thresholds and save the resulting MLE estimates in
<code>cutoff-varying-lag-estimates.csv</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">&lt;&lt;read-in-all-mcc-cluster-data&gt;&gt;

<span style="color: #6c3163; font-weight: bold;">pipeline</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>cutoff_factor<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  llhd_factory_applier<span style="color: #6c3163;">(</span>cutoff_factor, all_clusters_df,
                       daily_intro_log_probs, eii_df<span style="color: #6c3163;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    estimated_mle <span style="color: #715ab1;">%&gt;%</span>
    as.data.frame
<span style="color: #3a81c3;">}</span>

mle_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> map<span style="color: #3a81c3;">(</span>unique<span style="color: #6c3163;">(</span>all_clusters_df$cutoff<span style="color: #6c3163;">)</span>, pipeline<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  bind_rows <span style="color: #715ab1;">%&gt;%</span>
  mutate<span style="color: #3a81c3;">(</span>cutoff = as.numeric<span style="color: #6c3163;">(</span>as.character<span style="color: #2d9574;">(</span>cutoff<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

write.table<span style="color: #3a81c3;">(</span>x = mle_df,
            file = <span style="color: #2d9574;">"results/cutoff-varying-lag-estimates.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div id="cutoff-varying-lag-estimates"></div>

<script type="text/javascript">
var cutoffVaryingLagEstimates = "http://localhost:8000/cutoff-varying-lag-estimates.json";
vegaEmbed('#cutoff-varying-lag-estimates', cutoffVaryingLagEstimates).then(function(result) {
}).catch(console.error);
</script>
</div>
</div>

<div id="outline-container-org2c9abe7" class="outline-2">
<h2 id="org2c9abe7">Estimating the lag distribution VI (posterior tree uncertainty)</h2>
<div class="outline-text-2" id="text-org2c9abe7">
<p>
Another way to consider the uncertainty in the TMRCA estimates is to consider
multiple tree samples from the posterior. The file
<code>data/phylogenetics_data/2020-09-14/clusters_DTA.csv</code> describes the TMRCA data
under a set of posterior trees. The analysis is the same as above, but now
instead of using <code>cutoff</code> as the variable we use <code>tree</code> which describes which
posterior tree the data comes from. The script that will contain this analysis
is <code>lag-estimation-3.R</code>
</p>

<div class="org-src-container">
<pre class="src src-R">&lt;&lt;eii-and-llhd-setup&gt;&gt;

&lt;&lt;llhd-factory-applier-defn&gt;&gt;

&lt;&lt;estimate-mle-defn&gt;&gt;
</pre>
</div>

<p>
To use the functions from before we can just rename <code>tree</code> to <code>cutoff</code> and
change it back at the end before saving the results. This allows us to reuse the
code from above without needing to change the internals. The results are written
to the file <code>tree-varying-lag-estimates.csv</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">all_clusters_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"../../data/epidemiological/clusters_DTA.csv"</span>,
                            stringsAsFactors = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  mutate<span style="color: #3a81c3;">(</span>tmrca_date = as.Date<span style="color: #6c3163;">(</span>tmrca_calendar<span style="color: #6c3163;">)</span>,
         date_num = date_as_day_of_year<span style="color: #6c3163;">(</span>tmrca_date<span style="color: #6c3163;">)</span>,
         cutoff = as.factor<span style="color: #6c3163;">(</span>tree<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  select<span style="color: #3a81c3;">(</span>cluster, seqs, tmrca_date, date_num, cutoff<span style="color: #3a81c3;">)</span>

<span style="color: #6c3163; font-weight: bold;">pipeline</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>cutoff_factor<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  llhd_factory_applier<span style="color: #6c3163;">(</span>cutoff_factor, all_clusters_df,
                       daily_intro_log_probs, eii_df<span style="color: #6c3163;">)</span> <span style="color: #715ab1;">%&gt;%</span>
    estimated_mle <span style="color: #715ab1;">%&gt;%</span>
    as.data.frame
<span style="color: #3a81c3;">}</span>

&lt;&lt;run-parallel-pipeline&gt;&gt;

write.table<span style="color: #3a81c3;">(</span>x = mle_df,
            file = <span style="color: #2d9574;">"results/tree-varying-lag-estimates.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Since there are substantially larger number of trees than there were cutoffs we
will run the pipeline in parallel.
</p>

<p>
<code>run-parallel-pipeline</code>
</p>
<div class="org-src-container">
<pre class="src src-run-parallel-pipelineR" id="org46ff723">library(future)
plan(multiprocess)

mle_df &lt;- furrr::future_map(unique(all_clusters_df$cutoff), pipeline) %&gt;%
  bind_rows %&gt;%
  rename(tree = cutoff) %&gt;%
  mutate(tree = as.numeric(as.character(tree)))
</pre>
</div>

<div id="tree-varying-lag-estimates"></div>

<script type="text/javascript">
var treeVaryingLagEstimates = "http://localhost:8000/tree-varying-lag-estimates.json";
vegaEmbed('#tree-varying-lag-estimates', treeVaryingLagEstimates).then(function(result) {
}).catch(console.error);
</script>
</div>
</div>

<div id="outline-container-org7088cb1" class="outline-2">
<h2 id="org7088cb1">Extreme poverty adjustment</h2>
<div class="outline-text-2" id="text-org7088cb1">
</div>
<div id="outline-container-orgf913412" class="outline-3">
<h3 id="orgf913412">Estimating the proportion of potential seeders</h3>
<div class="outline-text-3" id="text-orgf913412">
<p>
This choropleth shows the World Bank data that informs the majority of the 
poverty estimates
</p>

<iframe src="https://ourworldindata.org/grapher/share-of-the-population-living-in-extreme-poverty?year=latest" loading="lazy" style="width: 100%; height: 600px; border: 0px none;"></iframe>

<p>
We are accounting for poverty as a proxy for access to healthcare and testing to
correct for the bias that countries with greater access to healthcare are likely
to ascertain more of the COVID-19 deaths than countries with lower access. To do
this, we replicate most of the calculations previously used to estimate the 
proportion of seeders, but now we adjust the population size to just consist of 
those not living in poverty.
</p>

<div class="org-src-container">
<pre class="src src-R">
&lt;&lt;age-of-infection-matrix-defn&gt;&gt;

&lt;&lt;padded-potential-seeders-defn&gt;&gt;

&lt;&lt;seeder-proportion-defn&gt;&gt;

<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>magrittr<span style="color: #3a81c3;">)</span>

&lt;&lt;jhu-un-location-unification&gt;&gt;

&lt;&lt;model-parameters&gt;&gt;
</pre>
</div>

<p>
Once we get to the population size component, we need to adjust it by the 
proportion living in extreme poverty.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">get_primary_sources</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>

  &lt;&lt;primary-source-locations-defn&gt;&gt;

  <span style="color: #3a81c3; font-weight: bold;">return</span><span style="color: #6c3163;">(</span>primary_source_locations<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

primary_source_locations <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> get_primary_sources<span style="color: #3a81c3;">()</span>

poverty_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read.csv<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"results/clean-worldbankpoverty.csv"</span><span style="color: #3a81c3;">)</span>
poverty_map <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> as.list<span style="color: #3a81c3;">(</span>poverty_df$latest_poverty_percentage<span style="color: #3a81c3;">)</span>
names<span style="color: #3a81c3;">(</span>poverty_map<span style="color: #3a81c3;">)</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> poverty_df$location

<span style="color: #6c3163; font-weight: bold;">location_seeder_props_adjusted</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">function</span><span style="color: #3a81c3;">(</span>location_str<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    deaths_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> filter<span style="color: #6c3163;">(</span>jhu_deaths, location == location_str<span style="color: #6c3163;">)</span> <span style="color: #715ab1;">%&gt;%</span>
        select<span style="color: #6c3163;">(</span>date,deaths<span style="color: #6c3163;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>is.element<span style="color: #2d9574;">(</span>location_str, un_populations$location<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
      non_poverty_prop <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>is.element<span style="color: #67b11d;">(</span>location_str, names<span style="color: #b1951d;">(</span>poverty_map<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                              <span style="color: #4e3163;">1</span> - <span style="color: #4e3163;">0.01</span> * poverty_map<span style="color: #67b11d;">[</span><span style="color: #b1951d;">[</span>location_str<span style="color: #b1951d;">]</span><span style="color: #67b11d;">]</span>
                          <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
                              <span style="color: #4e3163;">1</span> - <span style="color: #4e3163;">0.01</span> * poverty_map<span style="color: #67b11d;">[</span><span style="color: #b1951d;">[</span><span style="color: #2d9574;">"other"</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">]</span>
                          <span style="color: #2d9574;">}</span>
      pop_size <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">1e3</span> *
        un_populations<span style="color: #2d9574;">[</span>un_populations$location == location_str, <span style="color: #2d9574;">"population_size"</span><span style="color: #2d9574;">]</span> *
        non_poverty_prop
    <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
        <span style="color: #3a81c3; font-weight: bold;">stop</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"Cannot find a population size for "</span>, location_str<span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">}</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>length<span style="color: #2d9574;">(</span>pop_size<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">stop</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"Bad population size encountered for "</span>, location_str<span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">}</span>

    seeder_props <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seeder_proportion<span style="color: #6c3163;">(</span>deaths_df,
                                      pop_size,
                                      days_latent,
                                      days_incubating,
                                      days_infectious,
                                      prop_asymptomatic,
                                      days_infection_to_death,
                                      infection_fatality_ratio<span style="color: #6c3163;">)</span>

    seeder_props$location <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> location_str
    <span style="color: #3a81c3; font-weight: bold;">return</span><span style="color: #6c3163;">(</span>seeder_props<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>


result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> map<span style="color: #3a81c3;">(</span>.x = unique<span style="color: #6c3163;">(</span>jhu_deaths$location<span style="color: #6c3163;">)</span>,
              .f = location_seeder_props_adjusted<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  bind_rows <span style="color: #715ab1;">%&gt;%</span>
  filter<span style="color: #3a81c3;">(</span>date &lt; <span style="color: #2d9574;">"2020-07-01"</span><span style="color: #3a81c3;">)</span>

stopifnot<span style="color: #3a81c3;">(</span>!any<span style="color: #6c3163;">(</span>is.na<span style="color: #2d9574;">(</span>result$seeder_proportion<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

write.table<span style="color: #3a81c3;">(</span>x = result,
            file = <span style="color: #2d9574;">"results/estimated-proportion-seeders-poverty-adjusted.csv"</span>,
            sep = <span style="color: #2d9574;">","</span>,
            row.names = <span style="color: #4e3163;">FALSE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Then we to re-calculate the EII with the adjusted seeding proportions.
</p>
</div>
</div>

<div id="outline-container-org425c0c0" class="outline-3">
<h3 id="org425c0c0">Estimating the EII</h3>
<div class="outline-text-3" id="text-org425c0c0">
<p>
To estimate the EII under the adjusted population sizes we just copy the file 
<code>estimate-introduction-index.R</code> and replace the input file 
<code>estimated-proportion-seeders.csv</code> to 
<code>estimated-proportion-seeders-poverty-adjusted.csv</code> and the output file 
<code>estimated-introduction-index.csv</code> to 
<code>estimated-introduction-index-poverty-adjusted.csv</code> the new script for this is 
called <code>estimate-introduction-index-poverty-adjusted.R</code>
</p>

<p>
The changes to the EII are shown in the following figure
</p>

<div class="figure grid-figure">
  <img width=700px src="results/poverty-adjustment-sizes.png">
</div>
</div>
</div>
</div>

<div id="outline-container-org11c2dfd" class="outline-2">
<h2 id="org11c2dfd">Sensitivity to asymptomatic ratio</h2>
<div class="outline-text-2" id="text-org11c2dfd">
<p>
There are very different estimates of the asymptomatic ratio in the literature.
Since there is substantial uncertainty surrounding this parameter we performed a
sensitivity analysis to determine how it influences our results. Here are some
of the estimates, clicking on the point estimate will open the corresponding
article page.
</p>

<div id="asymptomatic-ratio-estimates"></div>

<script type="text/javascript">
var spec = "http://localhost:8000/parameter-vis-asymptomatic-ratio.json";
vegaEmbed('#asymptomatic-ratio-estimates', spec).then(function(result) {
}).catch(console.error);
</script>

<p>
We opted for \(31\%\) in the main results, but as a sensitivity analysis we
re-ran the calculations with both \(18\%\) and \(78\%\) to see how it would
influence the results. The simplest way to do this was just to change the
parameter value and then re-run all of the code, copying the file
<code>estimated-introduction-index.csv</code> each time as
<code>estimated-introduction-index-&lt;A&gt;.csv</code> for <code>&lt;A&gt;</code> as <code>18</code>, <code>31</code> and <code>78</code>.
</p>

<p>
The following figure shows the changes in the total EII as the asymptomatic
ratio is varied from \(18\%\) to \(78\%\) with the solid line indicating the
values at \(31\%\).
</p>

<div class="figure grid-figure">
  <img width=700px src="results/asymptomatic-uncertainty.png">
</div>
</div>
</div>

<div id="outline-container-org208346e" class="outline-2">
<h2 id="org208346e">Using this document and running the analysis</h2>
<div class="outline-text-2" id="text-org208346e">
<p>
There are a few steps involved in using this document and running the analysis
which we document here for clarity.
</p>
</div>

<div id="outline-container-org96858ca" class="outline-3">
<h3 id="org96858ca">Extracting source code and exporting HTML</h3>
<div class="outline-text-3" id="text-org96858ca">
<p>
The source code for the analysis is entirely contained within this document
(i.e., it is a literate program). To extract that code, run the following
command (assuming you have <code>emacs</code> installed).
</p>

<div class="org-src-container">
<pre class="src src-sh">emacs --batch -l org --eval <span style="color: #2d9574;">'(org-babel-tangle-file "epi-mobility-lag.org")'</span>
</pre>
</div>

<p>
To export the HTML version of this document (as <code>epi-mobility-lag.org</code>) run the
following command. Note that the warnings generated are a known issue but do not
affect the result.
</p>

<div class="org-src-container">
<pre class="src src-sh">emacs --batch -l org epi-mobility-lag.org --eval <span style="color: #2d9574;">'(org-html-export-to-html)'</span> 
</pre>
</div>
</div>
</div>

<div id="outline-container-org5358a41" class="outline-3">
<h3 id="org5358a41">Download the data</h3>
<div class="outline-text-3" id="text-org5358a41">
<p>
Some of it is already included in the <code>raw-data</code> directory, but there is other
data that we can download a fresh copy into <code>raw-data</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">wget <span style="color: #2d9574;">"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"</span>
mv time_series_covid19_deaths_global.csv raw-data/jhu-deaths.csv

wget <span style="color: #2d9574;">"https://population.un.org/wpp/Download/Files/1_Indicators%20(Standard)/CSV_FILES/WPP2019_TotalPopulationBySex.csv"</span>
mv WPP2019_TotalPopulationBySex.csv raw-data/un-population.csv
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e99828" class="outline-3">
<h3 id="org5e99828">Run the cleaning scripts</h3>
<div class="outline-text-3" id="text-org5e99828">
<p>
To get the data into a format that is easy to work with, run the
cleaning scripts. Note that these need to be run in order, and they assume that
certain files are available from within this repository.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">run-cleaning-scripts.sh</span>

Rscript clean-jhu-deaths.R
Rscript clean-un-population.R
Rscript clean-iata.R
Rscript clean-home-office.R
Rscript clean-non-air-travel.R

Rscript clean-elvidge-poverty.R
Rscript clean-owid-poverty.R
</pre>
</div>
</div>
</div>

<div id="outline-container-org3d40fb9" class="outline-3">
<h3 id="org3d40fb9">Run the estimation scripts</h3>
<div class="outline-text-3" id="text-org3d40fb9">
<p>
To estimate the epidemic introduction index the following scripts should be run.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">run-estimation-scripts.sh</span>

Rscript estimate-arrivals.R
Rscript estimate-potential-seeders.R
Rscript estimate-introduction-index.R

Rscript estimate-potential-seeders-poverty-adjusted.R
Rscript estimate-introduction-index-poverty-adjusted.R
Rscript poverty-adjustment-size.R
Rscript asymptomatic-adjustment-size.R
</pre>
</div>

<p>
Note that running both the poverty adjustment sensitivity analysis and the
asymptomatic ratio sensitivity analysis requires some additional steps, but
these are documented in the relevant sections.
</p>
</div>
</div>

<div id="outline-container-orgaa786ff" class="outline-3">
<h3 id="orgaa786ff">Running the simulations</h3>
<div class="outline-text-3" id="text-orgaa786ff">
<p>
This produces some output which then will be displayed in the HTML export of
this document.
</p>

<div class="org-src-container">
<pre class="src src-sh">Rscript simulation-study-1.R
Rscript simulation-study-2.R
Rscript simulation-study-3.R
</pre>
</div>
</div>
</div>

<div id="outline-container-org1bb917b" class="outline-3">
<h3 id="org1bb917b">Running the lag inference</h3>
<div class="outline-text-3" id="text-org1bb917b">
<p>
To run the actual inference on the real data run the following R script on
freshly tangled scripts. The main results are computed by <code>lag-estimation.R</code> but
there are sensitivity analyses in <code>lag-estimation-2.R</code> and <code>lag-estimation-3.R</code>
which are also of interest.
</p>

<div class="org-src-container">
<pre class="src src-sh">Rscript lag-estimation.R
Rscript lag-estimation-2.R
Rscript lag-estimation-3.R
</pre>
</div>
</div>
</div>

<div id="outline-container-orga48482e" class="outline-3">
<h3 id="orga48482e">Serving the HTML</h3>
<div class="outline-text-3" id="text-orga48482e">
<p>
To serve the HTML exported version of this file run the following command after
weaving it.
</p>

<div class="org-src-container">
<pre class="src src-sh">python3 -m http.server <span style="color: #4e3163;">8000</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Alex Zarebski</p>
<p class="date">Created: 2020-10-16 Fri 14:48</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
